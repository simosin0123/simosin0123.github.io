<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #F9FAFB; margin: 0; color: #222; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; padding: 30px 0; text-align: center; }
        h1 { font-size: 2.2em; font-weight: 700;}
        h2 { margin-top:1em;}
        .content, .auth-content { background: white; border-radius: 12px; box-shadow: 0 1px 5px rgba(0,0,0,0.08); padding: 30px;}
        .flex { display: flex; gap: 20px; flex-wrap: wrap;}
        .card { background: #F4F4FC; border-radius: 8px; padding: 18px; margin-bottom: 12px; border: 1px solid #E5E7EB;}
        .input-group { margin-bottom: 10px;}
        label { display: block; font-weight: 600; margin-bottom: 3px;}
        input[type=text],input[type=number],input[type=password],select {
            width: 100%; padding: 8px 12px; font-size: 1em;
            border-radius: 6px; border: 1.5px solid #D1D5DB; background: #fff; color: #222;
        }
        input:focus, select:focus { border-color: #7C3AED;}
        button {
            background: #4F46E5; color: white; border: none; padding: 8px 16px; border-radius: 6px;
            font-size: 1em; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        button:hover { background: #4338CA;}
        .danger { background: #E11D48!important;}
        .success { background: #059669!important;}
        .secondary { background: #64748b!important;}
        .small { font-size:0.9em;}
        .tab-bar {display: flex; border-radius:12px; overflow:hidden; margin-bottom:12px;}
        .tab-btn {
            flex:1; background:#E0E7FF; color:#444; padding:14px; cursor:pointer; text-align:center; border:none; font-weight:500;
        }
        .tab-btn.active {background:#4F46E5; color:white;}
        .expense-list { max-height: 320px; overflow-y: auto;}
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #E5E7EB;}
        .expense-item:last-child { border-bottom: none;}
        .expense-item strong { color: #7C3AED;}
        .delete-btn { background: #F43F5E; color: white; padding:4px 10px; font-size:0.95em; margin-left:8px;}
        .delete-btn:hover { background: #DC2626;}
        .edit-btn { background:#7C3AED; margin-left:5px;}
        .category-manage {display:flex;gap:5px;}
        .table {width:100%; border-collapse:collapse;}
        .table th,.table td {padding:8px; border-bottom:1px solid #E5E7EB; text-align:left;}
        .table th {background:#4F46E5; color:#fff;}
        .progress-bar { width:100%; height:10px; background:#E5E7EB; border-radius:6px; overflow:hidden;}
        .progress-fill {height:100%; background:linear-gradient(to right,#7C3AED,#4F46E5);}
        .alert { padding:12px; border-radius:6px; margin-bottom:8px; font-weight:500;}
        .alert-warning { background: #FEF3C7; color: #92400E;}
        .alert-success { background: #D1FAE5; color: #065F46;}
        .week-total-row { background:#c7d2fe!important; color:#1e293b; font-weight:bold;}
        @media (max-width:700px){
            .flex {flex-direction:column;}
            .content, .auth-content { padding: 12px;}
        }
    </style>
</head>
<body>
<header>
    <h1>ğŸ’° äºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼†ãƒ•ãƒ«ã‚«ã‚¹ã‚¿ãƒ </p>
</header>
<!-- èªè¨¼ç”»é¢ -->
<div id="loginScreen" class="auth-content" style="max-width:400px;margin:2em auto; display:none;">
    <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <div class="input-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="text" id="loginUsername"></div>
    <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="loginPassword"></div>
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button class="secondary" onclick="showRegister()">æ–°è¦ç™»éŒ²</button>
</div>
<div id="registerScreen" class="auth-content" style="max-width:400px;margin:2em auto; display:none;">
    <h2>æ–°è¦ç™»éŒ²</h2>
    <div class="input-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="text" id="registerUsername"></div>
    <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="registerPassword"></div>
    <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label><input type="password" id="registerPasswordConfirm"></div>
    <button onclick="register()">ç™»éŒ²</button>
    <button class="secondary" onclick="showLogin()">æˆ»ã‚‹</button>
</div>
<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
<div id="mainApp" style="display:none;">
    <div class="container">
        <div style="text-align:right;">
            <span class="small">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <b id="currentUser"></b></span>
            <button class="secondary" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <!-- æœˆã®åˆ‡ã‚Šæ›¿ãˆãƒ»æœˆåˆè¨­å®š -->
        <div style="margin:18px 0;text-align:center;">
            <button onclick="changeMonth(-1)">â† å‰æœˆ</button>
            <span id="currentMonth" style="font-weight:bold;font-size:1.1em;"></span>
            <button onclick="changeMonth(1)">æ¬¡æœˆ â†’</button>
            <button class="success" onclick="goToToday()">ä»Šæœˆã¸</button>
            <button class="secondary" onclick="changeMonthStartDay()">æœˆã®é–‹å§‹æ—¥ã‚’è¨­å®š</button>
        </div>
        <!-- ã‚¿ãƒ– -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="showTab('summary')">æ¦‚è¦</button>
            <button class="tab-btn" onclick="showTab('income')">åå…¥</button>
            <button class="tab-btn" onclick="showTab('budget')">äºˆç®—</button>
            <button class="tab-btn" onclick="showTab('expense')">æ”¯å‡º</button>
            <button class="tab-btn" onclick="showTab('weekly')">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
            <button class="tab-btn" onclick="showTab('settings')">è¨­å®š</button>
        </div>
        <!-- æ¦‚è¦ -->
        <div class="content" id="summaryTab">
            <h2>æœˆæ¬¡ã‚µãƒãƒªãƒ¼</h2>
            <div class="flex">
                <div class="card" style="flex:1;"><h3>åå…¥</h3><p style="font-size:1.3em">Â¥<span id="totalIncome">0</span></p></div>
                <div class="card" style="flex:1;"><h3>äºˆç®—åˆè¨ˆ</h3><p style="font-size:1.3em">Â¥<span id="totalBudget">0</span></p></div>
                <div class="card" style="flex:1;"><h3>æ”¯å‡ºåˆè¨ˆ</h3><p style="font-size:1.3em">Â¥<span id="totalExpense">0</span></p></div>
                <div class="card" style="flex:1;" id="remainingCard"><h3>æ®‹é¡</h3><p style="font-size:1.3em">Â¥<span id="remainingBudget">0</span></p></div>
            </div>
            <h3>ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥æ”¯å‡ºçŠ¶æ³</h3>
            <table class="table"><thead>
                <tr><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>äºˆç®—</th><th>æ”¯å‡º</th><th>æ®‹é¡</th><th>é€²æ—</th></tr>
            </thead><tbody id="categorySummary"></tbody></table>
            <div id="alerts"></div>
        </div>
        <!-- åå…¥ -->
        <div class="content" id="incomeTab" style="display:none;">
            <h2>åå…¥è¨­å®š</h2>
            <div id="incomeList"></div>
            <button onclick="addIncomeCategory()">ï¼‹åå…¥é …ç›®è¿½åŠ </button>
        </div>
        <!-- äºˆç®— -->
        <div class="content" id="budgetTab" style="display:none;">
            <h2>äºˆç®—è¨­å®š</h2>
            <div>
                <h3>å›ºå®šè²» <button class="small" onclick="addBudgetCategory('fixed')">ï¼‹è¿½åŠ </button></h3>
                <div id="budgetFixed"></div>
                <h3>è²¯è“„ãƒ»ç©ç«‹ <button class="small" onclick="addBudgetCategory('saving')">ï¼‹è¿½åŠ </button></h3>
                <div id="budgetSaving"></div>
                <h3>å¤‰å‹•è²» <button class="small" onclick="addBudgetCategory('variable')">ï¼‹è¿½åŠ </button></h3>
                <div id="budgetVariable"></div>
            </div>
        </div>
        <!-- æ”¯å‡º -->
        <div class="content" id="expenseTab" style="display:none;">
            <h2>æ”¯å‡ºå…¥åŠ›</h2>
            <div class="flex">
                <div class="card" style="flex:2;">
                    <div class="input-group"><label>æ—¥ä»˜</label>
                        <input type="date" id="expenseDate">
                    </div>
                    <div class="input-group"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select id="expenseCategory"></select>
                    </div>
                    <div class="input-group"><label>é‡‘é¡</label>
                        <input type="number" id="expenseAmount" placeholder="0">
                    </div>
                    <div class="input-group"><label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="expenseMemo">
                    </div>
                    <button onclick="addExpense(event)">æ”¯å‡ºã‚’è¿½åŠ </button>
                </div>
            </div>
            <h3>ä»Šæœˆã®æ”¯å‡ºä¸€è¦§</h3>
            <div class="expense-list" id="expenseList"></div>
        </div>
        <!-- é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ -->
        <div class="content" id="weeklyTab" style="display:none;">
            <h2>é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <table class="table"><thead>
                <tr>
                    <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                    <th>ç¬¬1é€±</th>
                    <th>ç¬¬2é€±</th>
                    <th>ç¬¬3é€±</th>
                    <th>ç¬¬4é€±</th>
                    <th>ç¬¬5é€±</th>
                    <th>æœˆåˆè¨ˆ</th>
                </tr>
            </thead>
            <tbody id="weeklyReport"></tbody>
            </table>
        </div>
        <!-- è¨­å®š -->
        <div class="content" id="settingsTab" style="display:none;">
            <h2>ã‚«ãƒ†ã‚´ãƒªãƒ»æœˆåˆè¨­å®š</h2>
            <div>
                <b>æœˆã®é–‹å§‹æ—¥ï¼š</b>
                <span id="currentStartDay"></span>
                <button onclick="changeMonthStartDay()">å¤‰æ›´</button>
            </div>
            <p>å„ã‚«ãƒ†ã‚´ãƒªãƒ»åå…¥åã®ç·¨é›†ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã¯å„ç”»é¢ã‹ã‚‰è¡Œãˆã¾ã™ã€‚</p>
            <button class="danger" onclick="resetAllData()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
    </div>
</div>
<div id="syncStatus" class="sync-status"></div>
<script>
// Firebase SDKã¯HTMLã®<head>ã§èª­ã¿è¾¼ã¿æ¸ˆã¿

// ==================================
// 1. Firebaseã¨åŸºæœ¬è¨­å®š
// ==================================
const firebaseConfig = {
    // çœç•¥ï¼šã‚ãªãŸã®Firebaseè¨­å®šã‚’ã“ã“ã«è¨˜è¿°
    apiKey: "...",
    authDomain: "...",
    projectId: "...",
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "...",
    measurementId: "..."
};

// åˆæœŸåŒ–
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();

// ãƒãƒ«ãƒã‚¿ãƒ–åŒæœŸã‚’æœ‰åŠ¹åŒ–
db.enablePersistence({ synchronizeTabs: true })
  .catch(err => {
    console.warn("Firestoreã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ã«å¤±æ•—:", err.code);
  });

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let data = {};
let currentUser = null;
let userUid = null;
let currentMonthKey = "";
let unsubscribe = null; // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã®è§£é™¤ç”¨
let calendarDate = new Date(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤ºç”¨

const LOCAL_STARTDAY_KEY = "budgetAppStartDay";
const LOCAL_MONTH_KEY = "budgetAppLastMonth";


// ==================================
// 2. èªè¨¼é–¢é€£
// ==================================
auth.onAuthStateChanged(user => {
    if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
    }

    if (user) {
        currentUser = user;
        userUid = user.uid;
        document.getElementById('currentUser').textContent = user.email;

        unsubscribe = db.collection("budgets").doc(userUid).onSnapshot(doc => {
            console.log("Firestoreãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚");
            if (doc.exists) {
                data = doc.data() || {};
            } else {
                console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€åˆæœŸåŒ–ã—ã¾ã™ã€‚");
                data = {};
                initializeMonth(getMonthKey(new Date()));
            }
            
            currentMonthKey = localStorage.getItem(LOCAL_MONTH_KEY) || getMonthKey(new Date());
            fullUpdateUI();
        }, error => {
            console.error("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼: ", error);
            alert("ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        });

        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('registerScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        
    } else {
        currentUser = null;
        userUid = null;
        data = {};
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('registerScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
    }
});

function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(email, password).catch(err => alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + err.message));
}

function register() {
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const confirm = document.getElementById('registerPasswordConfirm').value;
    if (password !== confirm) {
        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚");
        return;
    }
    auth.createUserWithEmailAndPassword(email, password).catch(err => alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + err.message));
}

function logout() {
    auth.signOut();
}

function showLogin() {
    document.getElementById('loginScreen').style.display = 'block';
    document.getElementById('registerScreen').style.display = 'none';
}

function showRegister() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('registerScreen').style.display = 'block';
}


// ==================================
// 3. ãƒ‡ãƒ¼ã‚¿æ“ä½œã¨åŒæœŸ
// ==================================
function initializeMonth(monthKey) {
    if (!data[monthKey]) {
        data[monthKey] = {
            income: [{ name: "ã‚¢ãƒ«ãƒã‚¤ãƒˆ", amount: 100000 }],
            budget: {
                fixed: [{ name: "å®¶è³ƒ", amount: 50000 }],
                savings: [{ name: "è²¯é‡‘", amount: 10000 }],
                variable: [{ name: "é£Ÿè²»", amount: 30000 }]
            },
            expenses: []
        };
        syncToFirestore();
    }
}

async function syncToFirestore() {
    if (!userUid) return;
    showSyncStatus('syncing', 'åŒæœŸä¸­...');
    try {
        await db.collection("budgets").doc(userUid).set(data, { merge: true });
        showSyncStatus('success', 'åŒæœŸå®Œäº†');
    } catch (e) {
        console.error("Firestoreã¸ã®æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
        showSyncStatus('error', 'åŒæœŸã‚¨ãƒ©ãƒ¼');
    }
}

// ==================================
// 4. UIæ›´æ–°ã¨è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
// ==================================
function showTab(tabId) {
    // å…¨ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
    ['summaryTab', 'incomeTab', 'budgetTab', 'expenseTab', 'weeklyTab', 'analysisTab', 'settingsTab'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤ºã—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
    document.getElementById(tabId).style.display = 'block';
    document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
}

function fullUpdateUI() {
    if (!currentUser || !data) return;
    updateHeader();
    updateDisplay();
    renderIncomeList();
    renderBudgetList();
    renderExpenseCategoryOptions();
    updateExpenseList();
    updateWeeklyReport();
    updateSettingsDisplay();
}

function updateDisplay() {
    initializeMonth(currentMonthKey);
    const monthData = data[currentMonthKey];
    
    // åˆè¨ˆå€¤ã®è¨ˆç®—
    const totalIncome = monthData.income.reduce((sum, item) => sum + item.amount, 0);
    const totalBudget = Object.values(monthData.budget).flat().reduce((sum, item) => sum + item.amount, 0);
    const totalExpense = monthData.expenses.reduce((sum, item) => sum + item.amount, 0);
    const remainingBudget = totalIncome - totalExpense;

    // DOMã«åæ˜ 
    document.getElementById('totalIncome').textContent = totalIncome.toLocaleString();
    document.getElementById('totalBudget').textContent = totalBudget.toLocaleString();
    document.getElementById('totalExpense').textContent = totalExpense.toLocaleString();
    document.getElementById('remainingBudget').textContent = remainingBudget.toLocaleString();
    
    // æ®‹é¡ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
    const remainingCard = document.getElementById('remainingCard');
    remainingCard.classList.toggle('negative', remainingBudget < 0);

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
    const categorySummaryBody = document.getElementById('categorySummary');
    categorySummaryBody.innerHTML = '';
    const allBudgets = Object.values(monthData.budget).flat();
    allBudgets.forEach(cat => {
        const catExpense = monthData.expenses.filter(ex => ex.category === cat.name).reduce((sum, ex) => sum + ex.amount, 0);
        const catRemaining = cat.amount - catExpense;
        const progress = cat.amount > 0 ? (catExpense / cat.amount) * 100 : 0;
        const row = `
            <tr>
                <td>${cat.name}</td>
                <td>Â¥${cat.amount.toLocaleString()}</td>
                <td>Â¥${catExpense.toLocaleString()}</td>
                <td>Â¥${catRemaining.toLocaleString()}</td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(progress, 100)}%;"></div>
                    </div>
                </td>
            </tr>
        `;
        categorySummaryBody.innerHTML += row;
    });
}

// â–¼â–¼â–¼ã€è£œè¶³ã€‘æ–°UIã«åˆã‚ã›ã¦è¡¨ç¤º/æ›´æ–°é–¢æ•°ã‚’ç´°åˆ†åŒ–ãƒ»ä¿®æ­£ â–¼â–¼â–¼
function renderIncomeList() {
    initializeMonth(currentMonthKey);
    const container = document.getElementById('incomeItems');
    container.innerHTML = '';
    data[currentMonthKey].income.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'editable-item';
        div.innerHTML = `
            <input type="text" value="${item.name}" onchange="updateItem('income', ${index}, 'name', this.value)">
            <input type="number" value="${item.amount}" onchange="updateItem('income', ${index}, 'amount', this.value)">
            <button class="delete-btn" onclick="deleteItem('income', ${index})">å‰Šé™¤</button>
        `;
        container.appendChild(div);
    });
}

function renderBudgetList() {
    initializeMonth(currentMonthKey);
    ['fixed', 'savings', 'variable'].forEach(type => {
        const containerId = type === 'fixed' ? 'fixedCostItems' : type === 'savings' ? 'savingsItems' : 'variableCostItems';
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        data[currentMonthKey].budget[type].forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'editable-item card'; // cardã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            div.innerHTML = `
                <input type="text" value="${item.name}" onchange="updateBudgetItem('${type}', ${index}, 'name', this.value)">
                <input type="number" value="${item.amount}" onchange="updateBudgetItem('${type}', ${index}, 'amount', this.value)">
                <button class="delete-btn" onclick="deleteBudgetItem('${type}', ${index})">å‰Šé™¤</button>
            `;
            container.appendChild(div);
        });
    });
}

function updateExpenseList() {
    initializeMonth(currentMonthKey);
    const list = document.getElementById('expenseList');
    list.innerHTML = '';
    data[currentMonthKey].expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((ex, index) => {
        const date = new Date(ex.date);
        const div = document.createElement('div');
        div.className = 'expense-item';
        // æ”¯å‡ºãƒªã‚¹ãƒˆã®å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
        const originalIndex = data[currentMonthKey].expenses.indexOf(ex);
        div.innerHTML = `
            <div>
                <strong>${date.getUTCMonth() + 1}/${date.getUTCDate()}</strong> - ${ex.category}
                <small>${ex.memo || ''}</small>
            </div>
            <div>
                <strong>Â¥${ex.amount.toLocaleString()}</strong>
                <button class="delete-btn" onclick="deleteExpense(${originalIndex})">Ã—</button>
            </div>
        `;
        list.appendChild(div);
    });
}

function updateWeeklyReport() {
    // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä»¥å‰ã®ã‚‚ã®ã‹ã‚‰æµç”¨ãƒ»èª¿æ•´ï¼‰
}

function updateHeader() {
    const range = getMonthRange(currentMonthKey);
    document.getElementById('currentMonth').textContent = `${range.start.getFullYear()}å¹´${range.start.getMonth() + 1}æœˆ`;
    document.getElementById('monthStartDay').textContent = range.start.getDate();
    document.getElementById('monthEndDay').textContent = range.end.getDate();
}

function showSyncStatus(type, message) {
    const statusDiv = document.getElementById('syncStatus');
    statusDiv.textContent = message;
    statusDiv.className = `sync-status ${type}`;
    statusDiv.style.display = 'block';
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 3000);
}


// ==================================
// 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã¨ã‚¤ãƒ™ãƒ³ãƒˆ
// ==================================
function changeMonth(diff) {
    const [year, month] = currentMonthKey.split('-').map(Number);
    const newDate = new Date(year, month - 1 + diff, getMonthStartDay());
    currentMonthKey = getMonthKey(newDate);
    localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
    fullUpdateUI();
}

function goToToday() {
    currentMonthKey = getMonthKey(new Date());
    localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
    fullUpdateUI();
}

// åå…¥ãƒ»äºˆç®—ã®CRUDï¼ˆä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ï¼‰
function addIncomeItem() {
    data[currentMonthKey].income.push({ name: 'æ–°è¦åå…¥', amount: 0 });
    syncToFirestore();
}
function addBudgetItem(type) {
    data[currentMonthKey].budget[type].push({ name: 'æ–°è¦é …ç›®', amount: 0 });
    syncToFirestore();
}
function updateItem(itemType, index, field, value) {
    const val = field === 'amount' ? Number(value) : value;
    data[currentMonthKey][itemType][index][field] = val;
    syncToFirestore();
}
function updateBudgetItem(type, index, field, value) {
    const val = field === 'amount' ? Number(value) : value;
    data[currentMonthKey].budget[type][index][field] = val;
    syncToFirestore();
}
function deleteItem(itemType, index) {
    if (confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        data[currentMonthKey][itemType].splice(index, 1);
        syncToFirestore();
    }
}
function deleteBudgetItem(type, index) {
    if (confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        data[currentMonthKey].budget[type].splice(index, 1);
        syncToFirestore();
    }
}

// æ”¯å‡ºã®CRUD
function renderExpenseCategoryOptions() {
    const select = document.getElementById('expenseCategory');
    select.innerHTML = '';
    const allBudgets = Object.values(data[currentMonthKey].budget).flat();
    allBudgets.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = cat.name;
        select.appendChild(option);
    });
}

function addExpense() {
    const dateStr = document.getElementById('expenseDate').value;
    if (!dateStr) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    const date = new Date(dateStr);
    const category = document.getElementById('expenseCategory').value;
    const amount = Number(document.getElementById('expenseAmount').value);
    const memo = document.getElementById('expenseMemo').value;

    if (!amount) {
        alert('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    const targetMonthKey = getMonthKey(date);
    initializeMonth(targetMonthKey);
    data[targetMonthKey].expenses.push({ date: date.toISOString(), category, amount, memo });
    syncToFirestore();
    
    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('expenseAmount').value = '';
    document.getElementById('expenseMemo').value = '';
}

function deleteExpense(index) {
    if (confirm('ã“ã®æ”¯å‡ºã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        data[currentMonthKey].expenses.splice(index, 1);
        syncToFirestore();
    }
}


// â–¼â–¼â–¼ã€è£œè¶³ã€‘ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãŸã‚ã®æ–°æ©Ÿèƒ½ â–¼â–¼â–¼
function showCalendar() {
    const popup = document.getElementById('calendarPopup');
    popup.classList.toggle('show');
    if (popup.classList.contains('show')) {
        renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
    }
}

function renderCalendar(year, month) {
    calendarDate = new Date(year, month);
    const grid = document.getElementById('calendarGrid');
    const monthSpan = document.getElementById('calendarMonth');
    monthSpan.textContent = `${year}å¹´ ${month + 1}æœˆ`;
    grid.innerHTML = '';

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
    ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
        grid.innerHTML += `<div style="font-weight:bold;font-size:12px;color:#6B7280;">${day}</div>`;
    });
    
    // ç©ºç™½ã‚»ãƒ«
    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += `<div></div>`;
    }
    // æ—¥ä»˜ã‚»ãƒ«
    for (let i = 1; i <= daysInMonth; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        dayDiv.textContent = i;
        dayDiv.onclick = () => selectDate(new Date(year, month, i));
        grid.appendChild(dayDiv);
    }
}

function changeCalendarMonth(diff) {
    calendarDate.setMonth(calendarDate.getMonth() + diff);
    renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
}

function selectDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    document.getElementById('expenseDate').value = `${year}-${month}-${day}`;
    showCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‰ã˜ã‚‹
}

// â–¼â–¼â–¼ã€è£œè¶³ã€‘è¨­å®šã‚¿ãƒ–ã®ãŸã‚ã®æ–°æ©Ÿèƒ½ â–¼â–¼â–¼
function updateMonthStartDay() {
    const startDay = Number(document.getElementById('monthStartDayInput').value);
    if (startDay >= 1 && startDay <= 28) {
        localStorage.setItem(LOCAL_STARTDAY_KEY, startDay);
        alert('æœˆã®é–‹å§‹æ—¥ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚');
        fullUpdateUI();
    } else {
        alert('1ã€œ28ã®é–“ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    }
}

function updateSettingsDisplay() {
    const startDay = getMonthStartDay();
    document.getElementById('monthStartDayInput').value = startDay;
    document.getElementById('settingsMonthStart').textContent = startDay;
    document.getElementById('settingsMonthEnd').textContent = (new Date(2024, 1, startDay - 1)).getDate();
}

// â–¼â–¼â–¼ã€è£œè¶³ã€‘åˆ†æã‚¿ãƒ–ã®ãŸã‚ã®æ–°æ©Ÿèƒ½ â–¼â–¼â–¼
function exportCSV() {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "æ—¥ä»˜,ã‚«ãƒ†ã‚´ãƒªãƒ¼,é‡‘é¡,ãƒ¡ãƒ¢\n";
    data[currentMonthKey].expenses.forEach(ex => {
        const date = new Date(ex.date).toLocaleDateString('ja-JP');
        const row = [date, ex.category, ex.amount, `"${ex.memo || ''}"`].join(',');
        csvContent += row + "\n";
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `budget_export_${currentMonthKey}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportAllData() {
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'budget-backup.json';
    link.click();
    URL.revokeObjectURL(url);
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = readerEvent => {
            try {
                const importedData = JSON.parse(readerEvent.target.result);
                if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    data = importedData;
                    syncToFirestore();
                    alert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                }
            } catch (err) {
                alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function resetAllData() {
    if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
        data = {};
        syncToFirestore();
    }
}

// ==================================
// 6. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨åˆæœŸåŒ–
// ==================================
function getMonthStartDay() {
    return parseInt(localStorage.getItem(LOCAL_STARTDAY_KEY) || "15");
}

function getMonthKey(date) {
    const d = new Date(date);
    const startDay = getMonthStartDay();
    if (d.getDate() < startDay) {
        d.setMonth(d.getMonth() - 1);
    }
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
}

function getMonthRange(monthKey) {
    if (!monthKey) { // monthKeyãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        monthKey = getMonthKey(new Date());
    }
    const [year, month] = monthKey.split('-').map(Number);
    const startDay = getMonthStartDay();
    const start = new Date(year, month - 1, startDay);
    const end = new Date(year, month, startDay - 1);
    return { start, end };
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–å‡¦ç†
window.onload = function() {
    showTab('summary');
};
</script>
</body>
</html>
