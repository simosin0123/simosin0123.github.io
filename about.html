<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>予算管理システム v3.3 </title>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #4F46E5; --primary-hover: #4338CA; --secondary-color: #6B7280;
            --success-color: #10B981; --danger-color: #EF4444; --background-light: #F9FAFB;
            --background-dark: #111827; --text-light: #111827; --text-dark: #F3F4F6;
            --surface-light: #FFFFFF; --surface-dark: #1F2937; --border-light: #E5E7EB;
            --border-dark: #4B5563; --danger-background: #FEE2E2; --danger-fill: #EF4444;
            --success-fill: #10B981;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--background-light); color: var(--text-light); line-height: 1.6; font-size: 16px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--primary-color) 0%, #7C3AED 100%); color: white; padding: 30px 0; text-align: center; }
        h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        h2 { color: var(--text-light); font-weight: 700; margin-bottom: 20px; }
        h3 { color: #374151; font-weight: 600; margin-bottom: 15px; margin-top: 30px;}
        .month-selector { margin: 20px 0; text-align: center; background: var(--surface-light); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .month-selector button { background: var(--primary-color); color: white; border: none; padding: 10px 20px; margin: 0 10px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.2s; }
        #currentMonth { font-size: 1.2em; font-weight: 700; color: var(--text-light); margin: 0 20px; }
        .tabs { display: flex; background: var(--surface-light); border-radius: 12px; overflow: hidden; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; border: none; background: var(--surface-light); font-size: 16px; font-weight: 500; color: #6B7280; }
        .tab.active { background: var(--primary-color); color: white; font-weight: 600; }
        .content { display: none; background: var(--surface-light); padding: 30px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .content.active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: #F9FAFB; padding: 20px; border-radius: 8px; border: 1px solid var(--border-light); }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 10px 12px; border: 2px solid var(--border-light); border-radius: 6px; font-size: 16px; background: var(--surface-light); color: var(--text-light); }
        button { background: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; margin-top: 10px; }
        button:hover { background: var(--primary-hover); }
        .delete-btn { background: var(--danger-color); }
        .editable-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #F3F4F6; border-radius: 6px; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .summary-table th, .summary-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-light); }
        .progress-bar-container { display: flex; align-items: center; gap: 10px; }
        .progress-bar { flex-grow: 1; height: 12px; background-color: #E5E7EB; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #4F46E5, #7C3AED); transition: width 0.5s ease-in-out; }
        .progress-fill.over-budget { background: var(--danger-fill); }
        .progress-text { font-size: 12px; font-weight: 600; color: #6B7280; min-width: 45px; text-align: right; }
        .comparison-increase { color: var(--danger-color); font-weight: bold; }
        .comparison-decrease { color: var(--success-color); font-weight: bold; }
        .calendar-input { position: relative; }
        .calendar-popup { position: absolute; top: 100%; left: 0; background: var(--surface-light); border: 1px solid var(--border-light); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; z-index: 1000; display: none; width: 320px; }
        .calendar-popup.show { display: block; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 600; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day, .calendar-weekday { padding: 8px; text-align: center; cursor: pointer; border-radius: 50%; }
        .calendar-weekday { cursor: default; font-weight: bold; color: #9CA3AF; }
        .sync-status { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; color: white; border-radius: 6px; font-size: 14px; z-index: 1000; transition: opacity 0.3s, transform 0.3s; opacity: 0; transform: translateY(10px); pointer-events: none; }
        .sync-status.show { opacity: 1; transform: translateY(0); }
        .sync-status.success { background: var(--success-color); }
        .sync-status.error { background: var(--danger-color); }
        .sync-status.syncing { background: var(--secondary-color); }
        @media (max-width: 768px) {
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
            .tabs::-webkit-scrollbar { display: none; }
            .tab { flex: 0 0 auto; padding: 15px 20px; }
        }
        @media (prefers-color-scheme: dark) {
            body { background-color: var(--background-dark); color: var(--text-dark); }
            h2, h3, #currentMonth { color: var(--text-dark); }
            .content, .month-selector, .tabs, .calendar-popup { background-color: var(--surface-dark); }
            .card, .editable-item { background-color: #374151; border-color: var(--border-dark); }
            input, select { background-color: #374151; color: var(--text-dark); border-color: var(--border-dark); }
            .tab:not(.active) { background: var(--surface-dark); color: #9CA3AF; }
            .summary-table th, .summary-table td { border-color: var(--border-dark); }
            .progress-bar { background-color: var(--border-dark); }
            .progress-text { color: #9CA3AF; }
        }
    </style>
</head>
<body>
    <header>
        <h1>💰 予算管理システム v3.3 (最終完成版)</h1>
        <p>あなたの予算をスマートに管理しましょう</p>
    </header>

    <div id="authContainer">
        <div class="container">
            <div id="loginScreen" class="content active" style="max-width: 400px; margin: 50px auto;">
                <h2 style="text-align: center;">🔐 ログイン</h2>
                <div class="input-group"><label>メールアドレス</label><input type="email" id="loginEmail"></div>
                <div class="input-group"><label>パスワード</label><input type="password" id="loginPassword"></div>
                <button onclick="login()" style="width: 100%;">ログイン</button>
                <button onclick="showRegister()" style="width: 100%; background: var(--success-color); margin-top: 10px;">新規登録はこちら</button>
            </div>
            <div id="registerScreen" class="content" style="max-width: 400px; margin: 50px auto;">
                <h2 style="text-align: center;">📝 新規登録</h2>
                <div class="input-group"><label>メールアドレス</label><input type="email" id="registerEmail"></div>
                <div class="input-group"><label>パスワード</label><input type="password" id="registerPassword"></div>
                <div class="input-group"><label>パスワード確認</label><input type="password" id="registerPasswordConfirm"></div>
                <button onclick="register()" style="width: 100%;">登録</button>
                <button onclick="showLogin()" style="width: 100%; background: var(--secondary-color); margin-top: 10px;">ログイン画面に戻る</button>
            </div>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="container">
            <div style="text-align: right; margin-bottom: 10px;">
                <span>ログイン中: <strong id="currentUser"></strong></span>
                <button onclick="logout()" style="background: var(--secondary-color); padding: 8px 16px; margin-left: 10px; margin-top: 0;">ログアウト</button>
            </div>
            <div class="month-selector">
                <button onclick="changeMonth(-1)">← 前月</button>
                <span id="currentMonth"></span>
                <button onclick="changeMonth(1)">次月 →</button>
                <button onclick="goToToday()" style="background: var(--success-color);">今月へ</button>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="showTab('summaryTab')">📊 概要</button>
                <button class="tab" onclick="showTab('incomeTab')">💵 収入</button>
                <button class="tab" onclick="showTab('budgetTab')">📝 予算</button>
                <button class="tab" onclick="showTab('expenseTab')">➕ 支出</button>
                <button class="tab" onclick="showTab('analysisTab')">📈 分析</button>
                <button class="tab" onclick="showTab('settingsTab')">⚙️ 設定</button>
            </div>
            
            <div id="summaryTab" class="content active">
                <h2>月次サマリー</h2>
                <div class="grid"><div class="card"><h3>収入</h3><p>¥<span id="totalIncome">0</span></p></div><div class="card"><h3>予算合計</h3><p>¥<span id="totalBudget">0</span></p></div><div class="card"><h3>支出合計</h3><p>¥<span id="totalExpense">0</span></p></div><div class="card" id="remainingCard"><h3>残額</h3><p>¥<span id="remainingBudget">0</span></p></div></div>
                <h3>カテゴリー別進捗</h3>
                <table class="summary-table"><thead><tr><th>カテゴリー</th><th style="width: 40%;">進捗</th><th>支出 / 予算</th><th>残額</th></tr></thead><tbody id="categorySummary"></tbody></table>
                <h3>今週の支出（カテゴリー別）</h3>
                <table class="summary-table"><thead><tr><th>カテゴリー</th><th>今週の支出</th><th>先週との比較</th></tr></thead><tbody id="weeklyCategorySummary"></tbody></table>
            </div>
            <div id="incomeTab" class="content"><h2>収入設定</h2><div id="incomeItems" class="grid"></div><button onclick="addIncomeItem()">+ 収入項目を追加</button></div>
            <div id="budgetTab" class="content">
                <h2>予算設定</h2>
                <h3>固定費</h3><div id="fixedCostItems" class="grid"></div><button onclick="addBudgetItem('fixed')">+ 固定費を追加</button>
                <h3 style="margin-top: 20px;">変動費</h3><div id="variableCostItems" class="grid"></div><button onclick="addBudgetItem('variable')">+ 変動費を追加</button>
                <h3 style="margin-top: 20px;">貯蓄・投資</h3><div id="savingsItems" class="grid"></div><button onclick="addBudgetItem('savings')">+ 貯蓄項目を追加</button>
            </div>
            <div id="expenseTab" class="content"><h2>支出入力</h2><div class="card"><div class="input-group"><label>日付</label><div class="calendar-input"><input type="text" id="expenseDate" readonly placeholder="クリックして日付を選択" onclick="toggleCalendar()"><div id="calendarPopup" class="calendar-popup"><div class="calendar-header"><button onclick="changeCalendarMonth(-1)">←</button><span id="calendarMonthLabel"></span><button onclick="changeCalendarMonth(1)">→</button></div><div class="calendar-grid" id="calendarWeekdays"></div><div class="calendar-grid" id="calendarGrid"></div></div></div></div><div class="input-group"><label>カテゴリー</label><select id="expenseCategory"></select></div><div class="input-group"><label>金額</label><input type="number" id="expenseAmount" placeholder="0"></div><div class="input-group"><label>メモ</label><input type="text" id="expenseMemo"></div><button onclick="addExpense(event)">支出を追加</button></div><h3 style="margin-top: 30px;">今月の支出一覧</h3><div id="expenseList" class="expense-list"></div></div>
            <div id="analysisTab" class="content"><h2>📈 分析</h2><div class="card"><h3>先月との支出比較</h3><p>カテゴリーごとの支出額を先月のデータと比較します。</p><div style="margin-top: 20px; height: 400px; position: relative;"><canvas id="comparisonChart"></canvas></div></div><div class="card" style="margin-top:20px;"><h3>データのエクスポート</h3><button onclick="exportCSV()">📊 CSVエクスポート</button></div></div>
            <div id="settingsTab" class="content"><h2>⚙️ 設定</h2><div class="settings-section card"><h3>月の開始日設定</h3><p>月の区切りとなる開始日を1〜28の間で設定できます。変更を適用すると、すべての支出データが新しい区切りに基づいて再計算されます。</p><div class="input-group" style="display: flex; align-items: center; gap: 10px;"><input type="number" id="monthStartDayInput" min="1" max="28" style="flex: 1; margin-top:0;"><button onclick="applyNewMonthStartDay()" style="flex-shrink: 0; margin-top:0;">変更を適用</button></div><p>現在の設定: <strong id="currentStartDayLabel">15</strong>日</p></div><div class="settings-section card" style="margin-top:20px;"><h3>全データリセット</h3><p>すべてのデータを削除します。この操作は元に戻せません。</p><button onclick="resetAllData()" class="delete-btn">🗑️ 全データ削除</button></div></div>
        </div>
    </div>
    <div id="syncStatus" class="sync-status"></div>

<script>
    // ▼▼▼ あなたのFirebase設定をここに！ ▼▼▼
    const firebaseConfig = {
  apiKey: "AIzaSyDFnNNb5wTESyC6zdWgG30oR1LVLr7Vc1o",
  authDomain: "josan-44288.firebaseapp.com",
  databaseURL: "https://josan-44288-default-rtdb.firebaseio.com",
  projectId: "josan-44288",
  storageBucket: "josan-44288.firebasestorage.app",
  messagingSenderId: "844486822796",
  appId: "1:844486822796:web:320679767e0ad86355a4a9",
  measurementId: "G-KTJRYVCV87"
};

    // 1. Firebaseと基本設定
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    db.enablePersistence({ synchronizeTabs: true }).catch(err => console.warn("永続化失敗:", err.code));

    let data = {}, currentUser = null, userUid = null, currentMonthKey = "", unsubscribe = null;
    let calendarDate = new Date();
    let comparisonChartInstance = null;
    const LOCAL_STARTDAY_KEY = "budgetAppStartDay";
    const LOCAL_MONTH_KEY = "budgetAppLastMonth";

    // 2. 認証関連
    auth.onAuthStateChanged(user => {
        if (unsubscribe) unsubscribe();
        if (user) {
            currentUser = user;
            userUid = user.uid;
            document.getElementById('currentUser').textContent = user.email.split('@')[0];
            unsubscribe = db.collection("budgets").doc(userUid).onSnapshot(doc => {
                data = doc.exists ? doc.data() : {};
                if (!doc.exists) initializeMonth(getMonthKey(new Date()));
                currentMonthKey = localStorage.getItem(LOCAL_MONTH_KEY) || getMonthKey(new Date());
                fullUpdateUI();
            }, error => console.error("リスナーエラー:", error));
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        } else {
            currentUser = null; userUid = null; data = {};
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            showLogin();
        }
    });
    function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        auth.signInWithEmailAndPassword(email, password).catch(err => alert("ログインエラー: " + err.message));
    }
    function register() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const confirm = document.getElementById('registerPasswordConfirm').value;
        if (password !== confirm) return alert("パスワードが一致しません。");
        auth.createUserWithEmailAndPassword(email, password).catch(err => alert("登録エラー: " + err.message));
    }
    function logout() { auth.signOut(); }
    function showLogin() {
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('registerScreen').style.display = 'none';
    }
    function showRegister() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('registerScreen').style.display = 'block';
    }

    // 3. データ操作と同期
    function initializeMonth(key) {
        if (!data[key]) {
            data[key] = {
                income: [{ name: "アルバイト", amount: 100000 }],
                budget: {
                    fixed: [{ name: "家賃", amount: 50000 }, { name: "通信費", amount: 5000 }],
                    variable: [{ name: "食費", amount: 30000 }, { name: "交際費", amount: 10000 }],
                    savings: [{ name: "積立NISA", amount: 33000 }]
                },
                expenses: []
            };
            syncToFirestore();
        }
    }
    async function syncToFirestore() {
        if (!userUid) return;
        showSyncStatus('syncing', '同期中...');
        try {
            await db.collection("budgets").doc(userUid).set(data, { merge: true });
            showSyncStatus('success', '同期完了');
        } catch (e) {
            console.error("書き込みエラー:", e);
            showSyncStatus('error', '同期エラー');
        }
    }

    // 4. UI更新と表示ロジック
    function showTab(tabId) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
        if (tabId === 'analysisTab') {
            setTimeout(renderComparisonChart, 50);
        }
    }
    function fullUpdateUI() {
        if (!currentUser || !currentMonthKey) return;
        initializeMonth(currentMonthKey);
        if (!data[currentMonthKey]) return;

        updateHeader();
        updateDisplay();
        renderIncomeList();
        renderBudgetList();
        renderExpenseCategoryOptions();
        updateExpenseList();
        updateSettingsDisplay();
        updateWeeklyCategorySummary();
        
        if (document.getElementById('analysisTab').classList.contains('active')) {
             renderComparisonChart();
        }
    }
    function updateDisplay() {
        const monthData = data[currentMonthKey];
        const totalIncome = monthData.income.reduce((s, i) => s + i.amount, 0);
        const allBudgets = Object.values(monthData.budget).flat();
        const totalBudget = allBudgets.reduce((s, i) => s + i.amount, 0);
        const totalExpense = monthData.expenses.reduce((s, i) => s + i.amount, 0);
        const remainingBudget = totalIncome - totalExpense;
        document.getElementById('totalIncome').textContent = totalIncome.toLocaleString();
        document.getElementById('totalBudget').textContent = totalBudget.toLocaleString();
        document.getElementById('totalExpense').textContent = totalExpense.toLocaleString();
        document.getElementById('remainingBudget').textContent = remainingBudget.toLocaleString();
        document.getElementById('remainingCard').classList.toggle('negative', remainingBudget < 0);
        
        const categorySummaryBody = document.getElementById('categorySummary');
        categorySummaryBody.innerHTML = '';
        allBudgets.forEach(cat => {
            const catExpense = monthData.expenses.filter(ex => ex.category === cat.name).reduce((sum, ex) => sum + ex.amount, 0);
            const catRemaining = cat.amount - catExpense;
            const progress = cat.amount > 0 ? (catExpense / cat.amount) * 100 : 0;
            categorySummaryBody.innerHTML += `<tr><td><strong>${cat.name}</strong></td><td><div class="progress-bar-container"><div class="progress-bar"><div class="progress-fill ${progress > 100 ? 'over-budget' : ''}" style="width: ${Math.min(progress, 100)}%;"></div></div><span class="progress-text">${progress.toFixed(1)}%</span></div></td><td>¥${catExpense.toLocaleString()} / ¥${cat.amount.toLocaleString()}</td><td>¥${catRemaining.toLocaleString()}</td></tr>`;
        });
    }
    function updateWeeklyCategorySummary() {
        const weeklySummaryBody = document.getElementById('weeklyCategorySummary');
        weeklySummaryBody.innerHTML = '';
        if (!data[currentMonthKey] || !data[currentMonthKey].expenses) return;
        
        const today = new Date();
        const thisBudgetMonthKey = getMonthKey(today);
        if(currentMonthKey !== thisBudgetMonthKey){
            weeklySummaryBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#9CA3AF;">現在の月ではないため、週次比較は表示されません。</td></tr>`;
            return;
        }
        const thisWeekNumber = getWeekNumber(today);
        
        const processWeekData = (weekNum) => {
            const totals = {};
            if (weekNum < 1) return totals;
            data[currentMonthKey].expenses
                .filter(ex => getWeekNumber(new Date(ex.date)) === weekNum)
                .forEach(ex => {
                    totals[ex.category] = (totals[ex.category] || 0) + ex.amount;
                });
            return totals;
        };
        const currentWeekTotals = processWeekData(thisWeekNumber);
        const prevWeekTotals = processWeekData(thisWeekNumber - 1);
        
        const labels = [...new Set([...Object.keys(currentWeekTotals), ...Object.keys(prevWeekTotals)])];
        if(labels.length === 0){
             weeklySummaryBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#9CA3AF;">今週と先週の支出データはありません。</td></tr>`;
            return;
        }

        labels.forEach(category => {
            const currentAmount = currentWeekTotals[category] || 0;
            const prevAmount = prevWeekTotals[category] || 0;
            let comparisonHTML = '-';
            let comparisonClass = '';

            if (prevAmount > 0) {
                const diff = currentAmount - prevAmount;
                const percent = (diff / prevAmount) * 100;
                if (diff > 0) {
                    comparisonClass = 'comparison-increase';
                    comparisonHTML = `↑ ${Math.abs(percent).toFixed(0)}%`;
                } else if (diff < 0) {
                    comparisonClass = 'comparison-decrease';
                    comparisonHTML = `↓ ${Math.abs(percent).toFixed(0)}%`;
                }
            } else if (currentAmount > 0) {
                comparisonClass = 'comparison-increase';
                comparisonHTML = '↑ (新規)';
            }
            weeklySummaryBody.innerHTML += `<tr><td><strong>${category}</strong></td><td>¥${currentAmount.toLocaleString()}</td><td class="${comparisonClass}">${comparisonHTML}</td></tr>`;
        });
    }
    function renderIncomeList() {
        const container = document.getElementById('incomeItems');
        container.innerHTML = '';
        data[currentMonthKey].income.forEach((item, index) => {
            container.innerHTML += `<div class="editable-item"><input type="text" value="${item.name}" onchange="updateItem('income', ${index}, 'name', this.value)"><input type="number" value="${item.amount}" onchange="updateItem('income', ${index}, 'amount', this.value)"><button class="delete-btn" onclick="deleteItem('income', ${index})">削除</button></div>`;
        });
    }
    function renderBudgetList() {
        ['fixed', 'variable', 'savings'].forEach(type => {
            const containerId = type === 'fixed' ? 'fixedCostItems' : type === 'variable' ? 'variableCostItems' : 'savingsItems';
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (data[currentMonthKey].budget[type]) {
                data[currentMonthKey].budget[type].forEach((item, index) => {
                    container.innerHTML += `<div class="editable-item card"><input type="text" value="${item.name}" onchange="updateBudgetItem('${type}', ${index}, 'name', this.value)"><input type="number" value="${item.amount}" onchange="updateBudgetItem('${type}', ${index}, 'amount', this.value)"><button class="delete-btn" onclick="deleteBudgetItem('${type}', ${index})">削除</button></div>`;
                });
            }
        });
    }
    function updateExpenseList() {
        const list = document.getElementById('expenseList');
        list.innerHTML = '';
        data[currentMonthKey].expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(ex => {
            const originalIndex = data[currentMonthKey].expenses.indexOf(ex);
            const date = new Date(ex.date);
            list.innerHTML += `<div class="expense-item"><div><strong>${date.getUTCDate()}日</strong> - ${ex.category} <small>${ex.memo||''}</small></div><div><strong>¥${ex.amount.toLocaleString()}</strong><button class="delete-btn" onclick="deleteExpense(${originalIndex})">×</button></div></div>`;
        });
    }
    function updateHeader() {
        document.getElementById('currentMonth').textContent = `${getMonthRange(currentMonthKey).start.getFullYear()}年 ${getMonthRange(currentMonthKey).start.getMonth() + 1}月`;
    }
    function showSyncStatus(type, message) {
        const statusDiv = document.getElementById('syncStatus');
        statusDiv.className = `sync-status ${type}`;
        statusDiv.textContent = message;
        statusDiv.classList.add('show');
        setTimeout(() => statusDiv.classList.remove('show'), 2000);
    }
    
    // 5. ユーザー操作とイベント
    function changeMonth(diff) {
        const [year, month] = currentMonthKey.split('-').map(Number);
        const newDate = new Date(year, month - 1 + diff, getMonthStartDay());
        currentMonthKey = getMonthKey(newDate);
        localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
        fullUpdateUI();
    }
    function goToToday() {
        currentMonthKey = getMonthKey(new Date());
        localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
        fullUpdateUI();
    }
    function addIncomeItem() {
        data[currentMonthKey].income.push({ name: '新規収入', amount: 0 });
        syncToFirestore();
    }
    function addBudgetItem(type) {
        data[currentMonthKey].budget[type].push({ name: '新規項目', amount: 0 });
        syncToFirestore();
    }
    function updateItem(itemType, index, field, value) {
        data[currentMonthKey][itemType][index][field] = field === 'amount' ? Number(value) : value;
        syncToFirestore();
    }
    function updateBudgetItem(type, index, field, value) {
        data[currentMonthKey].budget[type][index][field] = field === 'amount' ? Number(value) : value;
        syncToFirestore();
    }
    function deleteItem(itemType, index) {
        if(confirm('この項目を削除しますか？')) { data[currentMonthKey][itemType].splice(index, 1); syncToFirestore(); }
    }
    function deleteBudgetItem(type, index) {
        if(confirm('この項目を削除しますか？')) { data[currentMonthKey].budget[type].splice(index, 1); syncToFirestore(); }
    }
    function renderExpenseCategoryOptions() {
        const select = document.getElementById('expenseCategory');
        select.innerHTML = '';
        if (!data[currentMonthKey]) return;
        Object.values(data[currentMonthKey].budget).flat().forEach(cat => { select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`; });
    }
    function addExpense(event) {
        const btn = event.target;
        const dateStr = document.getElementById('expenseDate').value;
        if (!dateStr) return alert('日付を選択してください。');
        const amount = Number(document.getElementById('expenseAmount').value);
        if (!amount) return alert('金額は必須です。');
        btn.disabled = true;
        const category = document.getElementById('expenseCategory').value;
        const memo = document.getElementById('expenseMemo').value;
        const date = new Date(dateStr);
        const targetMonthKey = getMonthKey(date);
        initializeMonth(targetMonthKey);
        data[targetMonthKey].expenses.push({ date: date.toISOString(), category, amount, memo });
        syncToFirestore().then(() => {
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseMemo').value = '';
            btn.disabled = false;
        });
    }
    function deleteExpense(index) {
        if (confirm('この支出を削除しますか？')) { data[currentMonthKey].expenses.splice(index, 1); syncToFirestore(); }
    }

    // 6. 新機能：カレンダー
    function toggleCalendar() {
        const popup = document.getElementById('calendarPopup');
        const isVisible = popup.classList.toggle('show');
        if (isVisible) {
            const dateValue = document.getElementById('expenseDate').value;
            calendarDate = dateValue ? new Date(dateValue) : new Date();
            renderCalendar();
        }
    }
    function renderCalendar() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        document.getElementById('calendarMonthLabel').textContent = `${year}年 ${month + 1}月`;
        const grid = document.getElementById('calendarGrid');
        const weekdaysGrid = document.getElementById('calendarWeekdays');
        grid.innerHTML = '';
        weekdaysGrid.innerHTML = '';
        ['日','月','火','水','木','金','土'].forEach(day => weekdaysGrid.innerHTML += `<div class="calendar-weekday">${day}</div>`);
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) grid.innerHTML += `<div></div>`;
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = i;
            dayEl.onclick = () => selectDate(new Date(year, month, i));
            grid.appendChild(dayEl);
        }
    }
    function changeCalendarMonth(offset) {
        calendarDate.setMonth(calendarDate.getMonth() + offset);
        renderCalendar();
    }
    function selectDate(date) {
        document.getElementById('expenseDate').value = date.toISOString().slice(0, 10);
        toggleCalendar();
    }

    // 7. 新機能：設定
    function updateSettingsDisplay() {
        const startDay = getMonthStartDay();
        document.getElementById('currentStartDayLabel').textContent = startDay;
        document.getElementById('monthStartDayInput').value = startDay;
    }
    function applyNewMonthStartDay() {
        const newStartDay = parseInt(document.getElementById('monthStartDayInput').value);
        if (isNaN(newStartDay) || newStartDay < 1 || newStartDay > 28) return alert('1〜28の有効な数字を入力してください。');
        if (newStartDay === getMonthStartDay()) return alert('現在の設定と同じです。');
        if (!confirm(`月の開始日を「${newStartDay}日」に変更しますか？\n\n警告：すべての支出データが再計算されます。この操作は元に戻せません。`)) return;
        
        const allExpenses = Object.values(data).flatMap(monthData => monthData.expenses || []);
        Object.keys(data).forEach(key => { if(data[key] && data[key].expenses) data[key].expenses = []; });
        localStorage.setItem(LOCAL_STARTDAY_KEY, newStartDay);

        allExpenses.forEach(expense => {
            const newKey = getMonthKey(new Date(expense.date));
            initializeMonth(newKey);
            data[newKey].expenses.push(expense);
        });
        syncToFirestore().then(() => {
            currentMonthKey = getMonthKey(new Date());
            localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
            fullUpdateUI();
            alert('月の開始日を変更し、データを再計算しました。');
        });
    }
    function resetAllData() {
        if (confirm('本当にすべてのデータを削除しますか？元に戻せません。')) { data = {}; syncToFirestore(); }
    }

    // 8. 新機能：分析
    function renderComparisonChart() {
        if (!document.getElementById('analysisTab').classList.contains('active')) return;
        const ctx = document.getElementById('comparisonChart')?.getContext('2d');
        if (!ctx) return;
        if (comparisonChartInstance) comparisonChartInstance.destroy();

        const currentMonthData = data[currentMonthKey] || { expenses: [] };
        const [year, month] = currentMonthKey.split('-').map(Number);
        const prevMonthKey = getMonthKey(new Date(year, month - 2, getMonthStartDay()));
        initializeMonth(prevMonthKey);
        const prevMonthData = data[prevMonthKey] || { expenses: [] };

        const processData = (expenses) => {
            const totals = {};
            if(expenses) expenses.forEach(ex => { totals[ex.category] = (totals[ex.category] || 0) + ex.amount; });
            return totals;
        };
        const currentTotals = processData(currentMonthData.expenses);
        const prevTotals = processData(prevMonthData.expenses);
        const labels = [...new Set([...Object.keys(currentTotals), ...Object.keys(prevTotals)])];
        
        comparisonChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: `先月 (${prevMonthKey})`, data: labels.map(l => prevTotals[l] || 0), backgroundColor: 'rgba(107, 114, 128, 0.5)' },
                    { label: `今月 (${currentMonthKey})`, data: labels.map(l => currentTotals[l] || 0), backgroundColor: 'rgba(79, 70, 229, 0.6)' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }
    function exportCSV() {
        const expenses = data[currentMonthKey]?.expenses;
        if (!expenses || expenses.length === 0) return alert('エクスポートするデータがありません。');
        let csvContent = "data:text/csv;charset=utf-8,日付,カテゴリー,金額,メモ\n";
        expenses.forEach(ex => {
            csvContent += [new Date(ex.date).toLocaleDateString(), ex.category, ex.amount, `"${ex.memo || ''}"`].join(',') + "\r\n";
        });
        const link = document.createElement('a');
        link.href = encodeURI(csvContent);
        link.download = `budget_export_${currentMonthKey}.csv`;
        link.click();
    }
    
    // 9. ヘルパー関数と初期化
    function getMonthStartDay() { return parseInt(localStorage.getItem(LOCAL_STARTDAY_KEY) || "15"); }
    function getMonthKey(date) {
        const d = new Date(date);
        if (d.getDate() < getMonthStartDay()) d.setMonth(d.getMonth() - 1);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    }
    function getMonthRange(monthKey) {
        if (!monthKey) monthKey = getMonthKey(new Date());
        const [year, month] = monthKey.split('-').map(Number);
        const startDay = getMonthStartDay();
        const start = new Date(year, month - 1, startDay);
        const end = new Date(year, month, startDay - 1);
        return { start, end };
    }
    function getWeekNumber(date) {
        const monthStartDate = getMonthRange(currentMonthKey).start;
        const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const startDate = new Date(monthStartDate.getFullYear(), monthStartDate.getMonth(), monthStartDate.getDate());
        const diffTime = targetDate - startDate;
        if (diffTime < 0) return -1;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        return Math.floor(diffDays / 7) + 1;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        showTab('summaryTab');
        document.getElementById('expenseDate').value = new Date().toISOString().slice(0, 10);
    });
    
</script>
</body>
</html>
