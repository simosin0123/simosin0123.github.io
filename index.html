<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∫àÁÆóÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† v3.11 (ÊúÄÁµÇË™øÊï¥Áâà)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #4F46E5; --primary-hover: #4338CA; --secondary-color: #6B7280;
            --success-color: #10B981; --danger-color: #EF4444; --background-light: #F9FAFB;
            --background-dark: #111827; --text-light: #111827; --text-dark: #F3F4F6;
            --surface-light: #FFFFFF; --surface-dark: #1F2937; --border-light: #E5E7EB;
            --border-dark: #4B5563; --danger-background: #FEE2E2; --danger-fill: #EF4444;
            --success-fill: #10B981;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-light); color: var(--text-light);
            line-height: 1.6; font-size: 16px; transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--primary-color) 0%, #7C3AED 100%); color: white; padding: 30px 0; text-align: center; }
        h1 { font-size: 2.5em; font-weight: 700; }
        h2 { color: var(--text-light); font-weight: 700; margin-bottom: 20px; }
        h3 { color: #374151; font-weight: 600; margin-bottom: 15px; margin-top: 30px;}
        button, input, select { font-family: 'Noto Sans JP', sans-serif; }
        .month-selector { margin: 20px 0; text-align: center; background: var(--surface-light); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .month-selector button { background: var(--primary-color); color: white; border: none; padding: 10px 20px; margin: 0 10px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.2s; }
        #currentMonth { font-size: 1.2em; font-weight: 700; color: var(--text-light); margin: 0 20px; }
        .tabs { display: flex; background: var(--surface-light); border-radius: 12px; overflow: hidden; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; border: none; background: var(--surface-light); font-size: 16px; font-weight: 500; color: #6B7280; }
        .tab.active { background: var(--primary-color); color: white; font-weight: 600; }
        .content { display: none; background: var(--surface-light); padding: 30px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .content.active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: #F9FAFB; padding: 20px; border-radius: 8px; border: 1px solid var(--border-light); }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 10px 12px; border: 2px solid var(--border-light); border-radius: 6px; font-size: 16px; background: var(--surface-light); color: var(--text-light); }
        button { background: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; margin-top: 10px; }
        button:hover { background: var(--primary-hover); }
        button:active { transform: scale(0.98); }
        .delete-btn { background: var(--danger-color); }
        .editable-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #F3F4F6; border-radius: 6px; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .summary-table th, .summary-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-light); }
        .progress-bar-container { display: flex; align-items: center; gap: 10px; }
        .progress-bar { flex-grow: 1; height: 12px; background-color: #E5E7EB; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #4F46E5, #7C3AED); transition: width 0.5s ease-in-out; }
        .progress-fill.over-budget { background: var(--danger-fill); }
        .progress-text { font-size: 12px; font-weight: 600; color: #6B7280; min-width: 45px; text-align: right; }
        .comparison-increase { color: var(--danger-color); font-weight: bold; }
        .comparison-decrease { color: var(--success-color); font-weight: bold; }
        .calendar-input { position: relative; }
        .calendar-popup { position: absolute; top: 100%; left: 0; background: var(--surface-light); border: 1px solid var(--border-light); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; z-index: 1000; display: none; width: 320px; }
        .calendar-popup.show { display: block; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 600; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day, .calendar-weekday { padding: 8px; text-align: center; cursor: pointer; border-radius: 50%; }
        .calendar-weekday { cursor: default; font-weight: bold; color: #9CA3AF; }
        .sync-status { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; color: white; border-radius: 6px; font-size: 14px; z-index: 2000; transition: opacity 0.3s, transform 0.3s; opacity: 0; transform: translateY(10px); pointer-events: none; }
        .sync-status.show { opacity: 1; transform: translateY(0); }
        .sync-status.success { background: var(--success-color); }
        .sync-status.error { background: var(--danger-color); }
        .sync-status.syncing { background: var(--secondary-color); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card, .editable-item, .expense-item { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .card:nth-child(1), .editable-item:nth-child(1), .expense-item:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2), .editable-item:nth-child(2), .expense-item:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3), .editable-item:nth-child(3), .expense-item:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4), .editable-item:nth-child(4), .expense-item:nth-child(4) { animation-delay: 0.2s; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { background: var(--surface-light); color: var(--text-light); padding: 30px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); width: 90%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; color: var(--text-light); }
        .modal-content p { margin: 15px 0; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .modal-buttons button { margin-top: 0; }
        
        @media (max-width: 768px) {
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
            .tabs::-webkit-scrollbar { display: none; }
            .tab { flex: 0 0 auto; padding: 15px 20px; }
            .summary-table thead { display: none; }
            .summary-table tr { display: block; border: 1px solid var(--border-light); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
            .summary-table td { display: flex; justify-content: space-between; align-items: center; border-bottom: none; padding: 8px 0; }
            .summary-table td:before { content: attr(data-label); font-weight: 600; color: #6B7280; }
        }
        @media (prefers-color-scheme: dark) {
            body { background-color: var(--background-dark); color: var(--text-dark); }
            h2, h3, #currentMonth { color: var(--text-dark); }
            .content, .month-selector, .tabs { background-color: var(--surface-dark); }
            .card, .editable-item { background-color: #374151; border-color: var(--border-dark); }
            input, select { background-color: #374151; color: var(--text-dark); border-color: var(--border-dark); }
            .tab:not(.active) { background: var(--surface-dark); color: #9CA3AF; }
            .summary-table th, .summary-table td { border-color: var(--border-dark); }
            .progress-bar { background-color: var(--border-dark); }
            .progress-text { color: #9CA3AF; }

            /* ‚ñº‚ñº‚ñº„Äê‰ªäÂõû„ÅÆ‰øÆÊ≠£ÁÆáÊâÄ„Äë‚ñº‚ñº‚ñº */
            .modal-content {
                background-color: var(--surface-dark);
                color: var(--text-dark);
            }
            .modal-content h2 {
                color: var(--text-dark);
            }
            /* ‚ñ≤‚ñ≤‚ñ≤„Äê‰ªäÂõû„ÅÆ‰øÆÊ≠£ÁÆáÊâÄ„Äë‚ñ≤‚ñ≤‚ñ≤ */

            @media (max-width: 768px) {
                .summary-table tr { border-color: var(--border-dark); }
                .summary-table td:before { color: #9CA3AF; }
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üí∞ ‰∫àÁÆóÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† v3.11</h1>
        <p>„ÅÇ„Å™„Åü„ÅÆ‰∫àÁÆó„Çí„Çπ„Éû„Éº„Éà„Å´ÁÆ°ÁêÜ„Åó„Åæ„Åó„Çá„ÅÜ</p>
    </header>

    <div id="authContainer">
        <div class="container">
            <div id="loginScreen" class="content active" style="max-width: 400px; margin: 50px auto;">
                <h2 style="text-align: center;">üîê „É≠„Ç∞„Ç§„É≥</h2>
                <div class="input-group"><label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label><input type="email" id="loginEmail"></div>
                <div class="input-group"><label>„Éë„Çπ„ÉØ„Éº„Éâ</label><input type="password" id="loginPassword"></div>
                <button onclick="login()" style="width: 100%;">„É≠„Ç∞„Ç§„É≥</button>
                <button onclick="showRegister()" style="width: 100%; background: var(--success-color); margin-top: 10px;">Êñ∞Ë¶èÁôªÈå≤„ÅØ„Åì„Å°„Çâ</button>
            </div>
            <div id="registerScreen" class="content" style="max-width: 400px; margin: 50px auto;">
                <h2 style="text-align: center;">üìù Êñ∞Ë¶èÁôªÈå≤</h2>
                <div class="input-group"><label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label><input type="email" id="registerEmail"></div>
                <div class="input-group"><label>„Éë„Çπ„ÉØ„Éº„Éâ</label><input type="password" id="registerPassword"></div>
                <div class="input-group"><label>„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</label><input type="password" id="registerPasswordConfirm"></div>
                <button onclick="register()" style="width: 100%;">ÁôªÈå≤</button>
                <button onclick="showLogin()" style="width: 100%; background: var(--secondary-color); margin-top: 10px;">„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã</button>
            </div>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        </div>
    
    <div id="modalContainer" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <div id="modalButtons"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDFnNNb5wTESyC6zdWgG30oR1LVLr7Vc1o",
      authDomain: "josan-44288.firebaseapp.com",
      databaseURL: "https://josan-44288-default-rtdb.firebaseio.com",
      projectId: "josan-44288",
      storageBucket: "josan-44288.appspot.com",
      messagingSenderId: "844486822796",
      appId: "1:844486822796:web:320679767e0ad86355a4a9",
      measurementId: "G-KTJRYVCV87"
    };

    // ==================================
    // 1. Firebase„Å®Âü∫Êú¨Ë®≠ÂÆö
    // ==================================
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    db.enablePersistence({ synchronizeTabs: true }).catch(err => console.warn("Ê∞∏Á∂öÂåñÂ§±Êïó:", err.code));

    let data = {}, currentUser = null, userUid = null, currentMonthKey = "", unsubscribe = null;
    let calendarDate = new Date();
    let comparisonChartInstance = null;
    const LOCAL_STARTDAY_KEY = "budgetAppStartDay";
    const LOCAL_MONTH_KEY = "budgetAppLastMonth";
    const LATEST_SCHEMA_VERSION = 2;

    // ==================================
    // 2. „Éá„Éº„Çø„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥Ê©üËÉΩ
    // ==================================
    function runMigrations(userData) {
        const currentVersion = userData.schemaVersion || 1;
        let needsUpdate = false;
        if (currentVersion < 2) {
            console.log("„Éá„Éº„Çø„Çπ„Ç≠„Éº„Éû„Çív1„Åã„Çâv2„Å∏„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Åó„Åæ„Åô...");
            Object.keys(userData).forEach(key => {
                if (key.match(/^\d{4}-\d{2}$/) && userData[key].budget && !userData[key].budget.savings) {
                    userData[key].budget.savings = [
                        { name: "Á©çÁ´ãNISA", amount: 33000 },
                        { name: "Êµ∑Â§ñÊóÖË°å", amount: 10000 },
                        { name: "„Ç´„É°„É©Á©çÁ´ã", amount: 5000 }
                    ];
                    needsUpdate = true;
                }
            });
        }
        userData.schemaVersion = LATEST_SCHEMA_VERSION;
        return { migratedData: userData, needsUpdate };
    }

    // ==================================
    // 3. Ë™çË®ºÈñ¢ÈÄ£
    // ==================================
    auth.onAuthStateChanged(user => {
        if (unsubscribe) unsubscribe();
        if (user) {
            currentUser = user;
            userUid = user.uid;
            document.getElementById('currentUser').textContent = user.email.split('@')[0];
            unsubscribe = db.collection("budgets").doc(userUid).onSnapshot(doc => {
                let rawData = doc.exists ? doc.data() : {};
                const { migratedData, needsUpdate } = runMigrations(rawData);
                data = migratedData;
                if (needsUpdate || !doc.exists) {
                    if (!doc.exists) initializeMonth(getMonthKey(new Date()));
                    syncToFirestore();
                }
                currentMonthKey = localStorage.getItem(LOCAL_MONTH_KEY) || getMonthKey(new Date());
                fullUpdateUI();
            }, error => console.error("„É™„Çπ„Éä„Éº„Ç®„É©„Éº:", error));
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        } else {
            currentUser = null; userUid = null; data = {};
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            showLogin();
        }
    });

    function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        auth.signInWithEmailAndPassword(email, password).catch(err => showModal('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº', err.message));
    }

    function register() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const confirm = document.getElementById('registerPasswordConfirm').value;
        if (password !== confirm) return showModal('ÂÖ•Âäõ„Ç®„É©„Éº', '„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì„ÄÇ');
        auth.createUserWithEmailAndPassword(email, password).catch(err => showModal('ÁôªÈå≤„Ç®„É©„Éº', err.message));
    }

    function logout() { auth.signOut(); }

    function showLogin() {
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('registerScreen').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('registerScreen').style.display = 'block';
    }

    // ==================================
    // 4. „Éá„Éº„ÇøÊìç‰Ωú„Å®ÂêåÊúü
    // ==================================
    function initializeMonth(key) {
        if (!data[key]) {
            data[key] = {
                income: [{ name: "„Ç¢„É´„Éê„Ç§„Éà", amount: 120000 }],
                budget: {
                    savings: [ { name: "Á©çÁ´ãNISA", amount: 33000 }, { name: "Êµ∑Â§ñÊóÖË°å", amount: 10000 }, { name: "„Ç´„É°„É©Á©çÁ´ã", amount: 5000 } ],
                    fixed: [{ name: "ÂÆ∂Ë≥É", amount: 50000 }, { name: "ÈÄö‰ø°Ë≤ª", amount: 5000 }],
                    variable: [{ name: "È£üË≤ª", amount: 30000 }, { name: "‰∫§ÈöõË≤ª", amount: 15000 }]
                },
                expenses: []
            };
            if (!data.schemaVersion) {
                data.schemaVersion = LATEST_SCHEMA_VERSION;
            }
        }
    }

    async function syncToFirestore() {
        if (!userUid) return;
        showSyncStatus('syncing', 'ÂêåÊúü‰∏≠...');
        try {
            await db.collection("budgets").doc(userUid).set(data, { merge: true });
            showSyncStatus('success', 'ÂêåÊúüÂÆå‰∫Ü');
        } catch (e) {
            console.error("Êõ∏„ÅçËæº„Åø„Ç®„É©„Éº:", e);
            showSyncStatus('error', 'ÂêåÊúü„Ç®„É©„Éº');
        }
    }

    // ==================================
    // 5. UIÊõ¥Êñ∞„Å®Ë°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ
    // ==================================
    function showTab(tabId) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
        if (tabId === 'analysisTab') {
            setTimeout(renderComparisonChart, 50);
        }
    }

    function fullUpdateUI() {
        if (!currentUser || !currentMonthKey) return;
        initializeMonth(currentMonthKey);
        if (!data[currentMonthKey]) return;
        updateHeader();
        updateDisplay();
        renderIncomeList();
        renderBudgetList();
        renderExpenseCategoryOptions();
        updateExpenseList();
        updateSettingsDisplay();
        updateWeeklyCategorySummary();
        if (document.getElementById('analysisTab').classList.contains('active')) {
             renderComparisonChart();
        }
    }

    function updateDisplay() {
        const monthData = data[currentMonthKey];
        if (!monthData) return;
        const totalIncome = monthData.income.reduce((s, i) => s + i.amount, 0);
        const allBudgets = Object.values(monthData.budget).flat();
        const totalBudget = allBudgets.reduce((s, b) => s + b.amount, 0);
        const totalExpense = monthData.expenses.reduce((s, i) => s + i.amount, 0);
        const remainingBudget = totalIncome - totalExpense;
        document.getElementById('totalIncome').textContent = totalIncome.toLocaleString();
        document.getElementById('totalBudget').textContent = totalBudget.toLocaleString();
        document.getElementById('totalExpense').textContent = totalExpense.toLocaleString();
        document.getElementById('remainingBudget').textContent = remainingBudget.toLocaleString();
        document.getElementById('remainingCard').classList.toggle('negative', remainingBudget < 0);
        
        const categorySummaryBody = document.getElementById('categorySummary');
        categorySummaryBody.innerHTML = '';
        const renderCategoryRows = (categoryArray) => {
            if (!categoryArray) return;
            categoryArray.forEach(cat => {
                const catExpense = monthData.expenses.filter(ex => ex.category === cat.name).reduce((sum, ex) => sum + ex.amount, 0);
                const catRemaining = cat.amount - catExpense;
                const progress = cat.amount > 0 ? (catExpense / cat.amount) * 100 : (catExpense > 0 ? 100 : 0);
                categorySummaryBody.innerHTML += `<tr><td data-label="„Ç´„ÉÜ„Ç¥„É™„Éº"><strong>${cat.name}</strong></td><td data-label="ÈÄ≤Êçó"><div class="progress-bar-container"><div class="progress-bar"><div class="progress-fill ${progress >= 100 ? 'over-budget' : ''}" style="width: ${Math.min(progress, 100)}%;"></div></div><span class="progress-text">${progress.toFixed(1)}%</span></div></td><td data-label="ÊîØÂá∫ / ‰∫àÁÆó">¬•${catExpense.toLocaleString()} / ¬•${cat.amount.toLocaleString()}</td><td data-label="ÊÆãÈ°ç">¬•${catRemaining.toLocaleString()}</td></tr>`;
            });
        };
        renderCategoryRows(monthData.budget.savings);
        renderCategoryRows(monthData.budget.fixed);
        renderCategoryRows(monthData.budget.variable);
    }
    
    function updateWeeklyCategorySummary() {
        const weeklySummaryBody = document.getElementById('weeklyCategorySummary');
        weeklySummaryBody.innerHTML = '';
        if (!data[currentMonthKey] || !data[currentMonthKey].expenses) return;
        const today = new Date();
        const thisBudgetMonthKey = getMonthKey(today);
        if(currentMonthKey !== thisBudgetMonthKey){
            weeklySummaryBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#9CA3AF;">ÁèæÂú®„ÅÆÊúà„ÅÆ„Éá„Éº„Çø„Åß„ÅØ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÈÄ±Ê¨°ÊØîËºÉ„ÅØË°®Á§∫„Åï„Çå„Åæ„Åõ„Çì„ÄÇ</td></tr>`;
            return;
        }
        const thisWeekNumber = getWeekNumber(today);
        const processWeekData = (weekNum) => {
            const totals = {};
            if (weekNum < 1) return totals;
            data[currentMonthKey].expenses
                .filter(ex => getWeekNumber(new Date(ex.date)) === weekNum)
                .forEach(ex => {
                    totals[ex.category] = (totals[ex.category] || 0) + ex.amount;
                });
            return totals;
        };
        const currentWeekTotals = processWeekData(thisWeekNumber);
        const prevWeekTotals = processWeekData(thisWeekNumber - 1);
        const labels = [...new Set([...Object.keys(currentWeekTotals), ...Object.keys(prevWeekTotals)])];
        if(labels.length === 0){
             weeklySummaryBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#9CA3AF;">‰ªäÈÄ±„Å®ÂÖàÈÄ±„ÅÆÊîØÂá∫„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</td></tr>`;
            return;
        }
        labels.forEach(category => {
            const currentAmount = currentWeekTotals[category] || 0;
            const prevAmount = prevWeekTotals[category] || 0;
            let comparisonHTML = '-';
            let comparisonClass = '';
            if (prevAmount > 0) {
                const diff = currentAmount - prevAmount;
                const percent = (diff / prevAmount) * 100;
                if (diff > 0) {
                    comparisonClass = 'comparison-increase';
                    comparisonHTML = `‚Üë ${Math.abs(percent).toFixed(0)}%`;
                } else if (diff < 0) {
                    comparisonClass = 'comparison-decrease';
                    comparisonHTML = `‚Üì ${Math.abs(percent).toFixed(0)}%`;
                }
            } else if (currentAmount > 0) {
                comparisonClass = 'comparison-increase';
                comparisonHTML = '‚Üë (Êñ∞Ë¶è)';
            }
            weeklySummaryBody.innerHTML += `<tr><td data-label="„Ç´„ÉÜ„Ç¥„É™„Éº"><strong>${category}</strong></td><td data-label="‰ªäÈÄ±„ÅÆÊîØÂá∫">¬•${currentAmount.toLocaleString()}</td><td data-label="ÂÖàÈÄ±„Å®„ÅÆÊØîËºÉ" class="${comparisonClass}">${comparisonHTML}</td></tr>`;
        });
    }

    function renderIncomeList() {
        const container = document.getElementById('incomeItems');
        container.innerHTML = '';
        if(!data[currentMonthKey] || !data[currentMonthKey].income) return;
        data[currentMonthKey].income.forEach((item, index) => {
            container.innerHTML += `<div class="editable-item"><input type="text" value="${item.name}" onchange="updateItem('income', ${index}, 'name', this.value)"><input type="number" value="${item.amount}" onchange="updateItem('income', ${index}, 'amount', this.value)"><button class="delete-btn" onclick="deleteItem('income', ${index})">ÂâäÈô§</button></div>`;
        });
    }

    function renderBudgetList() {
        ['savings', 'fixed', 'variable'].forEach(type => {
            const containerId = type === 'savings' ? 'savingsItems' : type === 'fixed' ? 'fixedCostItems' : 'variableCostItems';
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (data[currentMonthKey] && data[currentMonthKey].budget && data[currentMonthKey].budget[type]) {
                data[currentMonthKey].budget[type].forEach((item, index) => {
                    container.innerHTML += `<div class="editable-item card"><input type="text" value="${item.name}" onchange="updateBudgetItem('${type}', ${index}, 'name', this.value)"><input type="number" value="${item.amount}" onchange="updateBudgetItem('${type}', ${index}, 'amount', this.value)"><button class="delete-btn" onclick="deleteBudgetItem('${type}', ${index})">ÂâäÈô§</button></div>`;
                });
            }
        });
    }

    function updateExpenseList() {
        const list = document.getElementById('expenseList');
        list.innerHTML = '';
        if(!data[currentMonthKey] || !data[currentMonthKey].expenses) return;
        data[currentMonthKey].expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(ex => {
            const originalIndex = data[currentMonthKey].expenses.indexOf(ex);
            const date = new Date(ex.date);
            list.innerHTML += `<div class="expense-item"><div><strong>${date.getUTCDate()}Êó•</strong> - ${ex.category} <small>${ex.memo||''}</small></div><div><strong>¬•${ex.amount.toLocaleString()}</strong><button class="delete-btn" onclick="deleteExpense(${originalIndex})">√ó</button></div></div>`;
        });
    }

    function updateHeader() {
        document.getElementById('currentMonth').textContent = `${getMonthRange(currentMonthKey).start.getFullYear()}Âπ¥ ${getMonthRange(currentMonthKey).start.getMonth() + 1}Êúà`;
    }

    function showSyncStatus(type, message) {
        const statusDiv = document.getElementById('syncStatus');
        statusDiv.className = `sync-status ${type}`;
        statusDiv.textContent = message;
        statusDiv.classList.add('show');
        setTimeout(() => statusDiv.classList.remove('show'), 2000);
    }
    
    // ==================================
    // 6. „É¶„Éº„Ç∂„ÉºÊìç‰Ωú„Å®„Ç§„Éô„É≥„Éà
    // ==================================
    function changeMonth(diff) {
        const [year, month] = currentMonthKey.split('-').map(Number);
        const newDate = new Date(year, month - 1 + diff, getMonthStartDay());
        currentMonthKey = getMonthKey(newDate);
        localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
        fullUpdateUI();
    }
    function goToToday() {
        currentMonthKey = getMonthKey(new Date());
        localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
        fullUpdateUI();
    }
    function addIncomeItem() {
        data[currentMonthKey].income.push({ name: 'Êñ∞Ë¶èÂèéÂÖ•', amount: 0 });
        syncToFirestore();
    }
    function addBudgetItem(type) {
        if (!data[currentMonthKey].budget[type]) {
            data[currentMonthKey].budget[type] = [];
        }
        data[currentMonthKey].budget[type].push({ name: 'Êñ∞Ë¶èÈ†ÖÁõÆ', amount: 0 });
        syncToFirestore();
    }
    function updateItem(itemType, index, field, value) {
        data[currentMonthKey][itemType][index][field] = field === 'amount' ? Number(value) : value;
        syncToFirestore();
    }
    function updateBudgetItem(type, index, field, value) {
        data[currentMonthKey].budget[type][index][field] = field === 'amount' ? Number(value) : value;
        syncToFirestore();
    }
    function deleteItem(itemType, index) {
        showModal('Á¢∫Ë™ç', `„Åì„ÅÆ${itemType === 'income' ? 'ÂèéÂÖ•' : '‰∫àÁÆó'}È†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`, [
            { text: 'ÂâäÈô§', class: 'danger', onClick: () => { data[currentMonthKey][itemType].splice(index, 1); syncToFirestore(); hideModal(); }},
            { text: '„Ç≠„É£„É≥„Çª„É´', class: 'secondary', onClick: hideModal }
        ]);
    }
    function deleteBudgetItem(type, index) {
        showModal('Á¢∫Ë™ç', '„Åì„ÅÆ‰∫àÁÆóÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', [
            { text: 'ÂâäÈô§', class: 'danger', onClick: () => { data[currentMonthKey].budget[type].splice(index, 1); syncToFirestore(); hideModal(); }},
            { text: '„Ç≠„É£„É≥„Çª„É´', class: 'secondary', onClick: hideModal }
        ]);
    }
    function renderExpenseCategoryOptions() {
        const select = document.getElementById('expenseCategory');
        select.innerHTML = '';
        if (!data[currentMonthKey]) return;
        Object.values(data[currentMonthKey].budget).flat().forEach(cat => { select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`; });
    }
    function addExpense(event) {
        const btn = event.target;
        const dateStr = document.getElementById('expenseDate').value;
        if (!dateStr) return showModal('ÂÖ•Âäõ„Ç®„É©„Éº', 'Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        const amount = Number(document.getElementById('expenseAmount').value);
        if (!amount) return showModal('ÂÖ•Âäõ„Ç®„É©„Éº', 'ÈáëÈ°ç„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ');
        btn.disabled = true;
        const category = document.getElementById('expenseCategory').value;
        const memo = document.getElementById('expenseMemo').value;
        const date = new Date(dateStr);
        const targetMonthKey = getMonthKey(date);
        initializeMonth(targetMonthKey);
        data[targetMonthKey].expenses.push({ date: date.toISOString(), category, amount, memo });
        syncToFirestore().then(() => {
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseMemo').value = '';
            btn.disabled = false;
        });
    }
    function deleteExpense(index) {
        showModal('Á¢∫Ë™ç', '„Åì„ÅÆÊîØÂá∫„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', [
            { text: 'ÂâäÈô§', class: 'danger', onClick: () => { data[currentMonthKey].expenses.splice(index, 1); syncToFirestore(); hideModal(); }},
            { text: '„Ç≠„É£„É≥„Çª„É´', class: 'secondary', onClick: hideModal }
        ]);
    }

    // ==================================
    // 7. Êñ∞Ê©üËÉΩÔºö„Ç´„É¨„É≥„ÉÄ„Éº
    // ==================================
    function toggleCalendar() {
        const popup = document.getElementById('calendarPopup');
        const isVisible = popup.classList.toggle('show');
        if (isVisible) {
            const dateValue = document.getElementById('expenseDate').value;
            calendarDate = dateValue ? new Date(dateValue) : new Date();
            renderCalendar();
        }
    }
    function renderCalendar() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        document.getElementById('calendarMonthLabel').textContent = `${year}Âπ¥ ${month + 1}Êúà`;
        const grid = document.getElementById('calendarGrid');
        const weekdaysGrid = document.getElementById('calendarWeekdays');
        grid.innerHTML = '';
        weekdaysGrid.innerHTML = '';
        ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'].forEach(day => weekdaysGrid.innerHTML += `<div class="calendar-weekday">${day}</div>`);
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) grid.innerHTML += `<div></div>`;
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = i;
            dayEl.onclick = () => selectDate(new Date(year, month, i));
            grid.appendChild(dayEl);
        }
    }
    function changeCalendarMonth(offset) {
        calendarDate.setMonth(calendarDate.getMonth() + offset);
        renderCalendar();
    }
    function selectDate(date) {
        document.getElementById('expenseDate').value = date.toISOString().slice(0, 10);
        toggleCalendar();
    }

    // ==================================
    // 8. Êñ∞Ê©üËÉΩÔºöË®≠ÂÆö
    // ==================================
    function updateSettingsDisplay() {
        const startDay = getMonthStartDay();
        document.getElementById('currentStartDayLabel').textContent = startDay;
        document.getElementById('monthStartDayInput').value = startDay;
    }
    function applyNewMonthStartDay() {
        const newStartDay = parseInt(document.getElementById('monthStartDayInput').value);
        if (isNaN(newStartDay) || newStartDay < 1 || newStartDay > 28) return showModal('ÂÖ•Âäõ„Ç®„É©„Éº','1„Äú28„ÅÆÊúâÂäπ„Å™Êï∞Â≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        if (newStartDay === getMonthStartDay()) return showModal('ÊÉÖÂ†±','ÁèæÂú®„ÅÆË®≠ÂÆö„Å®Âêå„Åò„Åß„Åô„ÄÇ');
        
        showModal('ÊúÄÁµÇÁ¢∫Ë™ç', `Êúà„ÅÆÈñãÂßãÊó•„Çí„Äå${newStartDay}Êó•„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü\nË≠¶ÂëäÔºö„Åô„Åπ„Å¶„ÅÆÊîØÂá∫„Éá„Éº„Çø„ÅåÂÜçË®àÁÆó„Åï„Çå„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`,[
            {text: 'Â§âÊõ¥„Åó„Å¶ÂÜçË®àÁÆó', class: 'danger', onClick: () => {
                const allExpenses = Object.values(data).flatMap(monthData => monthData.expenses || []);
                Object.keys(data).forEach(key => { if(data[key] && data[key].expenses) data[key].expenses = []; });
                localStorage.setItem(LOCAL_STARTDAY_KEY, newStartDay);
                allExpenses.forEach(expense => {
                    const newKey = getMonthKey(new Date(expense.date));
                    initializeMonth(newKey);
                    data[newKey].expenses.push(expense);
                });
                syncToFirestore().then(() => {
                    currentMonthKey = getMonthKey(new Date());
                    localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
                    fullUpdateUI();
                    showModal('ÂÆå‰∫Ü', 'Êúà„ÅÆÈñãÂßãÊó•„ÇíÂ§âÊõ¥„Åó„ÄÅ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂÜçË®àÁÆó„Åó„Åæ„Åó„Åü„ÄÇ');
                });
                hideModal();
            }},
            {text: '„Ç≠„É£„É≥„Çª„É´', class: 'secondary', onClick: hideModal }
        ]);
    }
    function resetAllData() {
        showModal('ÂÖ®„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà', 'Êú¨ÂΩì„Å´„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ', [
            {text: '„Åô„Åπ„Å¶ÂâäÈô§', class: 'danger', onClick: () => { data = {}; syncToFirestore(); hideModal(); }},
            {text: '„Ç≠„É£„É≥„Çª„É´', class: 'secondary', onClick: hideModal }
        ]);
    }

    // ==================================
    // 9. Êñ∞Ê©üËÉΩÔºöÂàÜÊûê
    // ==================================
    function renderComparisonChart() {
        if (!document.getElementById('analysisTab').classList.contains('active')) return;
        const ctx = document.getElementById('comparisonChart')?.getContext('2d');
        if (!ctx) return;
        if (comparisonChartInstance) comparisonChartInstance.destroy();
        const currentMonthData = data[currentMonthKey] || { expenses: [] };
        const [year, month] = currentMonthKey.split('-').map(Number);
        const prevMonthKey = getMonthKey(new Date(year, month - 2, getMonthStartDay()));
        initializeMonth(prevMonthKey);
        const prevMonthData = data[prevMonthKey] || { expenses: [] };
        const processData = (expenses) => {
            const totals = {};
            if(expenses) expenses.forEach(ex => { totals[ex.category] = (totals[ex.category] || 0) + ex.amount; });
            return totals;
        };
        const currentTotals = processData(currentMonthData.expenses);
        const prevTotals = processData(prevMonthData.expenses);
        const labels = [...new Set([...Object.keys(currentTotals), ...Object.keys(prevTotals)])];
        comparisonChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: `ÂÖàÊúà (${prevMonthKey})`, data: labels.map(l => prevTotals[l] || 0), backgroundColor: 'rgba(107, 114, 128, 0.5)' },
                    { label: `‰ªäÊúà (${currentMonthKey})`, data: labels.map(l => currentTotals[l] || 0), backgroundColor: 'rgba(79, 70, 229, 0.6)' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }
    function exportCSV() {
        const expenses = data[currentMonthKey]?.expenses;
        if (!expenses || expenses.length === 0) return showModal('ÊÉÖÂ†±','„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
        let csvContent = "data:text/csv;charset=utf-8,Êó•‰ªò,„Ç´„ÉÜ„Ç¥„É™„Éº,ÈáëÈ°ç,„É°„É¢\n";
        expenses.forEach(ex => {
            csvContent += [new Date(ex.date).toLocaleDateString(), ex.category, ex.amount, `"${ex.memo || ''}"`].join(',') + "\r\n";
        });
        const link = document.createElement('a');
        link.href = encodeURI(csvContent);
        link.download = `budget_export_${currentMonthKey}.csv`;
        link.click();
    }
    
    // ==================================
    // 10. Êñ∞Ê©üËÉΩÔºö„Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´
    // ==================================
    function showModal(title, message, buttons = [{ text: 'OK', onClick: hideModal }]) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message.replace(/\n/g, '<br>'); // ÊîπË°å„Çí<br>„Å´Â§âÊèõ
        const buttonsContainer = document.getElementById('modalButtons');
        buttonsContainer.innerHTML = '';
        buttons.forEach(btnInfo => {
            const button = document.createElement('button');
            button.textContent = btnInfo.text;
            button.onclick = btnInfo.onClick;
            if (btnInfo.class === 'danger') button.style.backgroundColor = 'var(--danger-color)';
            if (btnInfo.class === 'secondary') button.style.backgroundColor = 'var(--secondary-color)';
            buttonsContainer.appendChild(button);
        });
        const modalOverlay = document.getElementById('modalContainer');
        modalOverlay.style.display = 'flex';
        setTimeout(() => modalOverlay.classList.add('show'), 10);
    }
    function hideModal() {
        const modalOverlay = document.getElementById('modalContainer');
        modalOverlay.classList.remove('show');
        setTimeout(() => modalOverlay.style.display = 'none', 300);
    }

    // ==================================
    // 11. „Éò„É´„Éë„ÉºÈñ¢Êï∞„Å®ÂàùÊúüÂåñ
    // ==================================
    function getMonthStartDay() { return parseInt(localStorage.getItem(LOCAL_STARTDAY_KEY) || "15"); }
    function getMonthKey(date) {
        const d = new Date(date);
        if (d.getDate() < getMonthStartDay()) d.setMonth(d.getMonth() - 1);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    }
    function getMonthRange(monthKey) {
        if (!monthKey) monthKey = getMonthKey(new Date());
        const [year, month] = monthKey.split('-').map(Number);
        const startDay = getMonthStartDay();
        const start = new Date(year, month - 1, startDay);
        const end = new Date(year, month, startDay - 1);
        return { start, end };
    }
    function getWeekNumber(date) {
        const monthStartDate = getMonthRange(currentMonthKey).start;
        const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const startDate = new Date(monthStartDate.getFullYear(), monthStartDate.getMonth(), monthStartDate.getDate());
        const diffTime = targetDate - startDate;
        if (diffTime < 0) return -1;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        return Math.floor(diffDays / 7) + 1;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        showTab('summaryTab');
        const expenseDateInput = document.getElementById('expenseDate');
        if(expenseDateInput) {
            expenseDateInput.value = new Date().toISOString().slice(0, 10);
        }
    });
    
</script>
</body>
</html>
