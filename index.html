<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <meta name="description" content="å¤§å­¦ç”Ÿå‘ã‘ã®æœˆæ¬¡äºˆç®—ç®¡ç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="äºˆç®—ç®¡ç†">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        /* æ–°ã—ã„UIã®CSSï¼ˆçœç•¥ã›ãšã«ã™ã¹ã¦å«ã‚“ã§ã„ã¾ã™ï¼‰ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        ::selection { background-color: #4F46E5; color: white; }
        ::-moz-selection { background-color: #4F46E5; color: white; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #F9FAFB; color: #111827; line-height: 1.6; font-size: 16px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; padding: 30px 0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        h2 { color: #1F2937; font-weight: 700; margin-bottom: 20px; }
        h3 { color: #374151; font-weight: 600; margin-bottom: 15px; }
        .month-selector { margin: 20px 0; text-align: center; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .month-selector button { background: #4F46E5; color: white; border: none; padding: 10px 20px; margin: 0 10px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.2s; }
        .month-selector button:hover { background: #4338CA; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #currentMonth { font-size: 1.2em; font-weight: 700; color: #1F2937; margin: 0 20px; }
        .tabs { display: flex; background: white; border-radius: 12px; overflow: hidden; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; border: none; background: white; font-size: 16px; font-weight: 500; color: #6B7280; }
        .tab.active { background: #4F46E5; color: white; font-weight: 600; }
        .tab:hover:not(.active) { background: #F3F4F6; color: #1F2937; }
        .content { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .content.active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #F9FAFB; padding: 20px; border-radius: 8px; border: 1px solid #E5E7EB; position: relative; }
        .card h3 { color: #4F46E5; margin-bottom: 15px; font-size: 1.1em; font-weight: 600; }
        .card p { color: #1F2937; font-weight: 500; }
        #summaryTab .card { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); border: none; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); position: relative; overflow: hidden; }
        #summaryTab .card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); pointer-events: none; }
        #summaryTab .card h3 { color: rgba(255, 255, 255, 0.9); font-size: 0.95em; font-weight: 500; letter-spacing: 0.5px; margin-bottom: 10px; }
        #summaryTab .card p { color: white; font-size: 2em; font-weight: 700; text-shadow: 0 0 20px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.3); letter-spacing: -0.5px; }
        #summaryTab .card:last-child { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        #summaryTab .card:last-child.negative { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #374151; font-weight: 600; font-size: 14px; }
        input[type="number"], input[type="text"], input[type="date"], input[type="password"], input[type="email"], select { width: 100%; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 6px; font-size: 16px; transition: border-color 0.2s; background: white; color: #1F2937; font-weight: 500; }
        input:focus, select:focus { outline: none; border-color: #4F46E5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        button { background: #4F46E5; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; margin-top: 10px; }
        button:hover { background: #4338CA; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .summary-table th { background: #4F46E5; color: white; padding: 12px; text-align: left; font-weight: 600; }
        .summary-table td { padding: 12px; border-bottom: 1px solid #E5E7EB; color: #1F2937; font-weight: 500; }
        .summary-table tr:hover { background: #F9FAFB; }
        .expense-list { max-height: 400px; overflow-y: auto; }
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #E5E7EB; color: #1F2937; }
        .expense-item:hover { background: #F9FAFB; }
        .expense-item strong { color: #4F46E5; font-weight: 600; }
        .expense-item small { color: #6B7280; }
        .delete-btn { background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .delete-btn:hover { background: #DC2626; }
        .editable-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #F3F4F6; border-radius: 6px; }
        .editable-item input { flex: 1; margin-bottom: 0; }
        .editable-item button { padding: 6px 12px; font-size: 14px; margin: 0; }
        .settings-section { margin-top: 30px; padding: 20px; background: #F9FAFB; border-radius: 8px; border: 1px solid #E5E7EB; }
        .sync-status { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #10B981; color: white; border-radius: 6px; font-size: 14px; display: none; z-index: 1000; transition: opacity 0.3s, transform 0.3s; opacity: 0; transform: translateY(10px); }
        .sync-status.show { opacity: 1; transform: translateY(0); }
        .sync-status.error { background: #EF4444; }
        /* ä»–ã®CSS... */
    </style>
</head>
<body>
    <header>
        <h1>ğŸ’° äºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>æ¯æœˆ<span id="monthStartDayHeader">15</span>æ—¥ã€œç¿Œæœˆ<span id="monthEndDayHeader">14</span>æ—¥ã®äºˆç®—ã‚’ç®¡ç†</p>
    </header>

    <div id="loginScreen">
        <div class="container">
            <div class="content active" style="max-width: 400px; margin: 50px auto;">
                <h2 style="text-align: center;">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <div class="input-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="loginEmail" placeholder="example@email.com">
                </div>
                <div class="input-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
                <button onclick="login()" style="width: 100%;">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button onclick="showRegister()" style="width: 100%; background: #059669; margin-top: 10px;">æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</button>
            </div>
        </div>
    </div>

    <div id="registerScreen">
        <div class="container">
            <div class="content" style="max-width: 400px; margin: 50px auto;">
                <h2 style="text-align: center;">ğŸ“ æ–°è¦ç™»éŒ²</h2>
                <div class="input-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="registerEmail" placeholder="example@email.com">
                </div>
                <div class="input-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label>
                    <input type="password" id="registerPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š">
                </div>
                <div class="input-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›">
                </div>
                <button onclick="register()" style="width: 100%;">ç™»éŒ²</button>
                <button onclick="showLogin()" style="width: 100%; background: #6B7280; margin-top: 10px;">ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="mainApp">
        <div class="container">
            <div style="text-align: right; margin-bottom: 10px;">
                <span style="color: #6B7280;">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <strong id="currentUser"></strong></span>
                <button onclick="logout()" style="background: #6B7280; padding: 8px 16px; margin-left: 10px; margin-top: 0;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
                        
            <div class="month-selector">
                <button onclick="changeMonth(-1)">â† å‰æœˆ</button>
                <span id="currentMonth"></span>
                <button onclick="changeMonth(1)">æ¬¡æœˆ â†’</button>
                <button onclick="goToToday()" style="background: #48bb78;">ä»Šæœˆã¸</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('summaryTab')">ğŸ“Š æ¦‚è¦</button>
                <button class="tab" onclick="showTab('incomeTab')">ğŸ’µ åå…¥è¨­å®š</button>
                <button class="tab" onclick="showTab('budgetTab')">ğŸ“ äºˆç®—è¨­å®š</button>
                <button class="tab" onclick="showTab('expenseTab')">â• æ”¯å‡ºå…¥åŠ›</button>
                </div>
            
            <div id="summaryTab" class="content active">
                <h2>æœˆæ¬¡ã‚µãƒãƒªãƒ¼</h2>
                <div class="grid">
                    <div class="card"><h3>åå…¥</h3><p>Â¥<span id="totalIncome">0</span></p></div>
                    <div class="card"><h3>äºˆç®—åˆè¨ˆ</h3><p>Â¥<span id="totalBudget">0</span></p></div>
                    <div class="card"><h3>æ”¯å‡ºåˆè¨ˆ</h3><p>Â¥<span id="totalExpense">0</span></p></div>
                    <div class="card" id="remainingCard"><h3>æ®‹é¡</h3><p>Â¥<span id="remainingBudget">0</span></p></div>
                </div>
                <h3>ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥æ”¯å‡ºçŠ¶æ³</h3>
                <table class="summary-table">
                    <thead><tr><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>äºˆç®—</th><th>æ”¯å‡º</th><th>æ®‹é¡</th></tr></thead>
                    <tbody id="categorySummary"></tbody>
                </table>
            </div>
            
            <div id="incomeTab" class="content">
                <h2>åå…¥è¨­å®š</h2>
                <div id="incomeItems" class="grid"></div>
                <button onclick="addIncomeItem()">+ åå…¥é …ç›®ã‚’è¿½åŠ </button>
            </div>

            <div id="budgetTab" class="content">
                <h2>äºˆç®—è¨­å®š</h2>
                <h3>å›ºå®šè²»</h3>
                <div id="fixedCostItems" class="grid"></div>
                <button onclick="addBudgetItem('fixed')">+ å›ºå®šè²»é …ç›®ã‚’è¿½åŠ </button>
                <h3 style="margin-top: 20px;">å¤‰å‹•è²»</h3>
                <div id="variableCostItems" class="grid"></div>
                <button onclick="addBudgetItem('variable')">+ å¤‰å‹•è²»é …ç›®ã‚’è¿½åŠ </button>
            </div>

            <div id="expenseTab" class="content">
                <h2>æ”¯å‡ºå…¥åŠ›</h2>
                <div class="card">
                    <div class="input-group"><label>æ—¥ä»˜</label><input type="date" id="expenseDate"></div>
                    <div class="input-group"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label><select id="expenseCategory"></select></div>
                    <div class="input-group"><label>é‡‘é¡</label><input type="number" id="expenseAmount" placeholder="0"></div>
                    <div class="input-group"><label>ãƒ¡ãƒ¢</label><input type="text" id="expenseMemo"></div>
                    <button onclick="addExpense(event)">æ”¯å‡ºã‚’è¿½åŠ </button>
                </div>
                <h3 style="margin-top: 30px;">ä»Šæœˆã®æ”¯å‡ºä¸€è¦§</h3>
                <div id="expenseList" class="expense-list"></div>
            </div>
        </div>
    </div>

    <div id="syncStatus" class="sync-status"></div>

<script>
    // â–¼â–¼â–¼ ã‚ãªãŸã®Firebaseè¨­å®šã‚’ã“ã“ã«ï¼ â–¼â–¼â–¼
    const firebaseConfig = {
  apiKey: "AIzaSyDFnNNb5wTESyC6zdWgG30oR1LVLr7Vc1o",
  authDomain: "josan-44288.firebaseapp.com",
  databaseURL: "https://josan-44288-default-rtdb.firebaseio.com",
  projectId: "josan-44288",
  storageBucket: "josan-44288.firebasestorage.app",
  messagingSenderId: "844486822796",
  appId: "1:844486822796:web:320679767e0ad86355a4a9",
  measurementId: "G-KTJRYVCV87"
};

    // ==================================
    // 1. Firebaseã¨åŸºæœ¬è¨­å®š
    // ==================================
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    db.enablePersistence({ synchronizeTabs: true })
      .catch(err => console.warn("Firestoreã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ã«å¤±æ•—:", err.code));

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let data = {};
    let currentUser = null;
    let userUid = null;
    let currentMonthKey = "";
    let unsubscribe = null;
    const LOCAL_STARTDAY_KEY = "budgetAppStartDay";
    const LOCAL_MONTH_KEY = "budgetAppLastMonth";

    // ==================================
    // 2. èªè¨¼é–¢é€£
    // ==================================
    auth.onAuthStateChanged(user => {
        if (unsubscribe) unsubscribe();
        
        if (user) {
            currentUser = user;
            userUid = user.uid;
            document.getElementById('currentUser').textContent = user.email.split('@')[0];

            unsubscribe = db.collection("budgets").doc(userUid).onSnapshot(doc => {
                console.log("Firestoreãƒ‡ãƒ¼ã‚¿æ›´æ–°");
                data = doc.exists ? doc.data() : {};
                if (!doc.exists) {
                    initializeMonth(getMonthKey(new Date()));
                }
                currentMonthKey = localStorage.getItem(LOCAL_MONTH_KEY) || getMonthKey(new Date());
                fullUpdateUI();
            }, error => {
                console.error("ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼: ", error);
                alert("ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            });

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        } else {
            currentUser = null;
            userUid = null;
            data = {};
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
        }
    });

    function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        auth.signInWithEmailAndPassword(email, password).catch(err => alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + err.message));
    }

    function register() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const confirm = document.getElementById('registerPasswordConfirm').value;
        if (password !== confirm) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚");
        auth.createUserWithEmailAndPassword(email, password).catch(err => alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + err.message));
    }

    function logout() {
        auth.signOut();
    }

    function showLogin() {
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('registerScreen').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('registerScreen').style.display = 'block';
    }

    // ==================================
    // 3. ãƒ‡ãƒ¼ã‚¿æ“ä½œã¨åŒæœŸ
    // ==================================
    function initializeMonth(monthKey) {
        if (!data[monthKey]) {
            data[monthKey] = {
                income: [{ name: "ã‚¢ãƒ«ãƒã‚¤ãƒˆ", amount: 100000 }],
                budget: {
                    fixed: [{ name: "å®¶è³ƒ", amount: 50000 }, { name: "é€šä¿¡è²»", amount: 5000 }],
                    variable: [{ name: "é£Ÿè²»", amount: 30000 }, { name: "äº¤éš›è²»", amount: 10000 }]
                },
                expenses: []
            };
            syncToFirestore();
        }
    }

    async function syncToFirestore() {
        if (!userUid) return;
        showSyncStatus('syncing', 'åŒæœŸä¸­...');
        try {
            await db.collection("budgets").doc(userUid).set(data, { merge: true });
            showSyncStatus('success', 'åŒæœŸå®Œäº†');
        } catch (e) {
            console.error("æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
            showSyncStatus('error', 'åŒæœŸã‚¨ãƒ©ãƒ¼');
        }
    }
    
    // ==================================
    // 4. UIæ›´æ–°ã¨è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
    // ==================================
    function showTab(tabId) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    function fullUpdateUI() {
        if (!currentUser || !data[currentMonthKey]) return;
        updateHeader();
        updateDisplay();
        renderIncomeList();
        renderBudgetList();
        renderExpenseCategoryOptions();
        updateExpenseList();
    }

    function updateDisplay() {
        const monthData = data[currentMonthKey];
        if (!monthData) return;
        
        const totalIncome = monthData.income.reduce((s, i) => s + i.amount, 0);
        const allBudgets = Object.values(monthData.budget).flat();
        const totalBudget = allBudgets.reduce((s, i) => s + i.amount, 0);
        const totalExpense = monthData.expenses.reduce((s, i) => s + i.amount, 0);
        const remainingBudget = totalIncome - totalExpense;

        document.getElementById('totalIncome').textContent = totalIncome.toLocaleString();
        document.getElementById('totalBudget').textContent = totalBudget.toLocaleString();
        document.getElementById('totalExpense').textContent = totalExpense.toLocaleString();
        document.getElementById('remainingBudget').textContent = remainingBudget.toLocaleString();
        document.getElementById('remainingCard').classList.toggle('negative', remainingBudget < 0);

        const summaryBody = document.getElementById('categorySummary');
        summaryBody.innerHTML = '';
        allBudgets.forEach(cat => {
            const expense = monthData.expenses.filter(ex => ex.category === cat.name).reduce((s, ex) => s + ex.amount, 0);
            summaryBody.innerHTML += `<tr><td>${cat.name}</td><td>Â¥${cat.amount.toLocaleString()}</td><td>Â¥${expense.toLocaleString()}</td><td>Â¥${(cat.amount - expense).toLocaleString()}</td></tr>`;
        });
    }

    function renderIncomeList() {
        const container = document.getElementById('incomeItems');
        container.innerHTML = '';
        data[currentMonthKey].income.forEach((item, index) => {
            container.innerHTML += `<div class="editable-item"><input type="text" value="${item.name}" onchange="updateItem('income', ${index}, 'name', this.value)"><input type="number" value="${item.amount}" onchange="updateItem('income', ${index}, 'amount', this.value)"><button class="delete-btn" onclick="deleteItem('income', ${index})">å‰Šé™¤</button></div>`;
        });
    }

    function renderBudgetList() {
        ['fixed', 'variable'].forEach(type => {
            const container = document.getElementById(type === 'fixed' ? 'fixedCostItems' : 'variableCostItems');
            container.innerHTML = '';
            data[currentMonthKey].budget[type].forEach((item, index) => {
                container.innerHTML += `<div class="editable-item card"><input type="text" value="${item.name}" onchange="updateBudgetItem('${type}', ${index}, 'name', this.value)"><input type="number" value="${item.amount}" onchange="updateBudgetItem('${type}', ${index}, 'amount', this.value)"><button class="delete-btn" onclick="deleteBudgetItem('${type}', ${index})">å‰Šé™¤</button></div>`;
            });
        });
    }

    function updateExpenseList() {
        const list = document.getElementById('expenseList');
        list.innerHTML = '';
        data[currentMonthKey].expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(ex => {
            const originalIndex = data[currentMonthKey].expenses.indexOf(ex);
            const date = new Date(ex.date);
            list.innerHTML += `<div class="expense-item"><div><strong>${date.getUTCDate()}æ—¥</strong> - ${ex.category} <small>${ex.memo||''}</small></div><div><strong>Â¥${ex.amount.toLocaleString()}</strong><button class="delete-btn" onclick="deleteExpense(${originalIndex})">Ã—</button></div></div>`;
        });
    }

    function updateHeader() {
        const range = getMonthRange(currentMonthKey);
        document.getElementById('currentMonth').textContent = `${range.start.getFullYear()}å¹´ ${range.start.getMonth() + 1}æœˆ`;
        document.getElementById('monthStartDayHeader').textContent = range.start.getDate();
        document.getElementById('monthEndDayHeader').textContent = range.end.getDate();
    }
    
    function showSyncStatus(type, message) {
        const statusDiv = document.getElementById('syncStatus');
        statusDiv.className = `sync-status ${type}`;
        statusDiv.textContent = message;
        statusDiv.classList.add('show');
        setTimeout(() => statusDiv.classList.remove('show'), 2000);
    }

    // ==================================
    // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã¨ã‚¤ãƒ™ãƒ³ãƒˆ
    // ==================================
    function changeMonth(diff) {
        const [year, month] = currentMonthKey.split('-').map(Number);
        const newDate = new Date(year, month - 1 + diff, getMonthStartDay());
        currentMonthKey = getMonthKey(newDate);
        localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
        fullUpdateUI();
    }

    function goToToday() {
        currentMonthKey = getMonthKey(new Date());
        localStorage.setItem(LOCAL_MONTH_KEY, currentMonthKey);
        fullUpdateUI();
    }

    function addIncomeItem() {
        data[currentMonthKey].income.push({ name: 'æ–°è¦åå…¥', amount: 0 });
        syncToFirestore();
    }
    function addBudgetItem(type) {
        data[currentMonthKey].budget[type].push({ name: 'æ–°è¦é …ç›®', amount: 0 });
        syncToFirestore();
    }
    function updateItem(itemType, index, field, value) {
        data[currentMonthKey][itemType][index][field] = field === 'amount' ? Number(value) : value;
        syncToFirestore();
    }
    function updateBudgetItem(type, index, field, value) {
        data[currentMonthKey].budget[type][index][field] = field === 'amount' ? Number(value) : value;
        syncToFirestore();
    }
    function deleteItem(itemType, index) {
        if(confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            data[currentMonthKey][itemType].splice(index, 1);
            syncToFirestore();
        }
    }
    function deleteBudgetItem(type, index) {
        if(confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            data[currentMonthKey].budget[type].splice(index, 1);
            syncToFirestore();
        }
    }

    function renderExpenseCategoryOptions() {
        const select = document.getElementById('expenseCategory');
        select.innerHTML = '';
        Object.values(data[currentMonthKey].budget).flat().forEach(cat => {
            select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    }

    function addExpense(event) {
        const btn = event.target;
        btn.disabled = true;
        const date = document.getElementById('expenseDate').value;
        const category = document.getElementById('expenseCategory').value;
        const amount = Number(document.getElementById('expenseAmount').value);
        const memo = document.getElementById('expenseMemo').value;

        if (!date || !amount) {
            alert('æ—¥ä»˜ã¨é‡‘é¡ã¯å¿…é ˆã§ã™ã€‚');
            btn.disabled = false;
            return;
        }

        const targetMonthKey = getMonthKey(new Date(date));
        initializeMonth(targetMonthKey);
        data[targetMonthKey].expenses.push({ date, category, amount, memo });
        syncToFirestore().then(() => {
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseMemo').value = '';
            btn.disabled = false;
        });
    }

    function deleteExpense(index) {
        if (confirm('ã“ã®æ”¯å‡ºã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            data[currentMonthKey].expenses.splice(index, 1);
            syncToFirestore();
        }
    }

    // ==================================
    // 6. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨åˆæœŸåŒ–
    // ==================================
    function getMonthStartDay() {
        return parseInt(localStorage.getItem(LOCAL_STARTDAY_KEY) || "15");
    }

    function getMonthKey(date) {
        const d = new Date(date);
        if (d.getDate() < getMonthStartDay()) {
            d.setMonth(d.getMonth() - 1);
        }
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    }

    function getMonthRange(monthKey) {
        if (!monthKey) monthKey = getMonthKey(new Date());
        const [year, month] = monthKey.split('-').map(Number);
        const startDay = getMonthStartDay();
        const start = new Date(year, month - 1, startDay);
        const end = new Date(year, month, startDay - 1);
        return { start, end };
    }

    // åˆæœŸã‚¿ãƒ–è¡¨ç¤º
    showTab('summaryTab');
    // åˆæœŸæ—¥ä»˜è¨­å®š
    document.getElementById('expenseDate').value = new Date().toISOString().slice(0, 10);

</script>
</body>
</html>
